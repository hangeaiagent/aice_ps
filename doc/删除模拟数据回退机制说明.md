# 删除模拟数据回退机制 - 代码修改说明

## 修改时间
2025-09-25

## 修改目标
1. 删除所有API搜索网络图片的回退机制
2. 确保异常时真实抛出错误，不使用模拟数据
3. 让前端能够正确处理和显示错误信息

## 修改文件清单

### 1. services/textToComicService.ts
**位置**: `/services/textToComicService.ts`

#### 修改内容：

##### A. OCR文字提取 (第67-71行)
```typescript
// 原代码：
} catch (error) {
  console.error('OCR 错误:', error);
  // 如果 OCR 服务不可用，返回示例文本
  return this.getMockText();
}

// 修改后：
} catch (error) {
  console.error('OCR 错误:', error);
  // 直接抛出异常，不使用模拟数据
  throw new Error(`OCR文字提取失败: ${error instanceof Error ? error.message : '未知错误'}`);
}
```

##### B. Deepseek场景提取 (第97-105行)
```typescript
// 原代码：
} catch (proxyError) {
  console.error('后端代理失败，尝试直接调用:', proxyError);
}
// 如果没有配置 API Key，使用模拟数据
if (!this.deepseekApiKey) {
  return this.getMockScenes(text);
}

// 修改后：
} catch (proxyError) {
  console.error('后端代理失败:', proxyError);
  throw new Error(`场景提取API调用失败: ${proxyError instanceof Error ? proxyError.message : '未知错误'}`);
}
// 如果没有配置 API Key，抛出错误
if (!this.deepseekApiKey) {
  throw new Error('Deepseek API未配置，无法提取场景');
}
```

##### C. Deepseek响应解析失败 (第166-170行)
```typescript
// 原代码：
} catch (parseError) {
  console.error('解析 Deepseek 响应失败:', parseError);
  // 如果解析失败，使用备用方案
  return this.getMockScenes(text);
}

// 修改后：
} catch (parseError) {
  console.error('解析 Deepseek 响应失败:', parseError);
  // 直接抛出解析错误
  throw new Error(`解析场景数据失败: ${parseError instanceof Error ? parseError.message : '未知错误'}`);
}
```

##### D. Deepseek API调用失败 (第171-175行)
```typescript
// 原代码：
} catch (error) {
  console.error('Deepseek API 调用失败:', error);
  // 使用模拟数据作为后备
  return this.getMockScenes(text);
}

// 修改后：
} catch (error) {
  console.error('Deepseek API 调用失败:', error);
  // 直接抛出异常
  throw new Error(`场景提取失败: ${error instanceof Error ? error.message : '未知错误'}`);
}
```

##### E. Nanobanana图片生成 (第210-218行)
```typescript
// 原代码：
} catch (proxyError) {
  console.error('后端代理失败，尝试直接调用:', proxyError);
}
// 如果没有配置 API Key，使用模拟图片
if (!this.nanobananaApiKey) {
  return this.getMockComicImage(description);
}

// 修改后：
} catch (proxyError) {
  console.error('后端代理失败:', proxyError);
  throw new Error(`图片生成API调用失败: ${proxyError instanceof Error ? proxyError.message : '未知错误'}`);
}
// 如果没有配置 API Key，抛出错误
if (!this.nanobananaApiKey) {
  throw new Error('Nanobanana API未配置，无法生成图片');
}
```

##### F. Nanobanana API调用失败 (第252-256行)
```typescript
// 原代码：
} catch (error) {
  console.error('Nanobanana API 调用失败:', error);
  // 使用占位图片
  return this.getMockComicImage(description);
}

// 修改后：
} catch (error) {
  console.error('Nanobanana API 调用失败:', error);
  // 直接抛出异常
  throw new Error(`图片生成失败: ${error instanceof Error ? error.message : '未知错误'}`);
}
```

##### G. 删除模拟数据函数 (第260-322行)
完全删除了以下不再使用的函数：
- `getMockText()` - 模拟OCR文本
- `getMockScenes()` - 模拟场景提取
- `generateMockDescription()` - 生成模拟场景描述
- `getMockComicImage()` - 获取占位图片

## 影响分析

### 前端行为变化
1. **错误处理更明确**：所有API调用失败都会抛出明确的错误信息
2. **无回退机制**：不再使用模拟数据或占位图片
3. **用户体验**：用户将看到真实的错误信息，而不是静默失败

### 错误信息格式
所有错误都采用统一格式：
```typescript
throw new Error(`操作失败描述: ${error instanceof Error ? error.message : '未知错误'}`);
```

### 前端调用方需要处理的异常
调用 `TextToComicService` 的组件需要使用 try-catch 处理以下异常：
- OCR文字提取失败
- 场景提取API调用失败
- 场景数据解析失败
- 图片生成API调用失败
- API未配置错误

## 建议的前端错误处理示例
```typescript
try {
  const result = await textToComicService.extractTextFromImage(file);
  // 处理成功结果
} catch (error) {
  // 显示错误信息给用户
  showErrorMessage(error.message);
  // 记录错误日志
  console.error('操作失败:', error);
}
```

## 测试建议
1. 测试OCR服务不可用时的错误提示
2. 测试Deepseek API未配置时的错误提示
3. 测试图片生成服务失败时的错误提示
4. 验证所有错误信息都能正确显示给用户
5. 确保没有遗留的模拟数据显示

## 回滚方案
如需回滚，可以：
1. 恢复 `getMockText()`, `getMockScenes()`, `getMockComicImage()` 等函数
2. 将 throw 语句改回 return 模拟数据的调用
3. 重新启用后备方案逻辑
