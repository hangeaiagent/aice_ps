# 04会员权限管理实现方案

## 基于 Nano Banana AI 的会员权限管理系统设计

### 1. 权限管理概述

#### 1.1 Nano Banana AI 权限分析
根据定价页面分析，Nano Banana AI 采用分层权限管理：

```javascript
// 权限层级结构
const PERMISSION_LEVELS = {
  starter: {
    level: 1,
    features: ['nano_banana', 'veo3_video', 'sticker', 'basic_templates'],
    limits: { credits: 560, priority: 'normal' }
  },
  advanced: {
    level: 2, 
    features: ['nano_banana', 'veo3_video', 'sticker', 'all_templates', 'batch_processing'],
    limits: { credits: 1680, priority: 'high' }
  },
  professional: {
    level: 3,
    features: ['nano_banana', 'veo3_video', 'sticker', 'all_templates', 'batch_processing', 'professional_canvas'],
    limits: { credits: 4200, priority: 'highest' }
  },
  lifetime: {
    level: 4,
    features: ['all_features', 'dedicated_manager'],
    limits: { credits: 4200, priority: 'vip' }
  }
};
```

#### 1.2 权限管理核心功能
- **功能权限控制**: 基于订阅等级的功能访问控制
- **积分配额管理**: 不同等级的积分使用限制
- **优先级队列**: 处理任务的优先级管理
- **动态权限更新**: 订阅变更时的权限实时更新

### 2. 数据库权限表设计

#### 2.1 权限定义表 (permissions)
```sql
CREATE TABLE permissions (
    id BIGSERIAL PRIMARY KEY,
    permission_code VARCHAR(100) UNIQUE NOT NULL, -- nano_banana, veo3_video, batch_processing
    permission_name VARCHAR(200) NOT NULL,
    permission_name_en VARCHAR(200) NOT NULL,
    description TEXT,
    category VARCHAR(50) NOT NULL, -- feature, limit, priority
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 2.2 角色权限表 (role_permissions)
```sql
CREATE TABLE role_permissions (
    id BIGSERIAL PRIMARY KEY,
    plan_id BIGINT REFERENCES subscription_plans(id) ON DELETE CASCADE,
    permission_id BIGINT REFERENCES permissions(id) ON DELETE CASCADE,
    permission_value JSONB, -- 权限值配置
    is_enabled BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(plan_id, permission_id)
);
```

#### 2.3 用户权限缓存表 (user_permissions_cache)
```sql
CREATE TABLE user_permissions_cache (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id) ON DELETE CASCADE UNIQUE,
    permissions JSONB NOT NULL, -- 用户当前权限快照
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 2.4 权限使用日志表 (permission_usage_logs)
```sql
CREATE TABLE permission_usage_logs (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id) ON DELETE CASCADE,
    permission_code VARCHAR(100) NOT NULL,
    action VARCHAR(100) NOT NULL, -- check, grant, deny, consume
    resource_type VARCHAR(50), -- image, video, batch_job
    resource_id VARCHAR(255),
    result VARCHAR(20) NOT NULL, -- allowed, denied, consumed
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 3. 权限管理服务实现

#### 3.1 权限服务核心类
```python
# services/permission_service.py
from typing import Dict, List, Any, Optional
from sqlalchemy.orm import Session
from app.models.user import User
from app.models.subscription import UserSubscription
from app.models.permission import Permission, RolePermission, UserPermissionCache
from app.core.cache import redis_client
import json
from datetime import datetime, timedelta

class PermissionService:
    def __init__(self, db: Session):
        self.db = db
        self.cache_ttl = 3600  # 1小时缓存
    
    def get_user_permissions(self, user_id: int, force_refresh: bool = False) -> Dict[str, Any]:
        """获取用户权限"""
        cache_key = f"user_permissions:{user_id}"
        
        # 尝试从Redis缓存获取
        if not force_refresh:
            cached_permissions = redis_client.get(cache_key)
            if cached_permissions:
                return json.loads(cached_permissions)
        
        # 从数据库获取用户当前订阅
        subscription = self.db.query(UserSubscription).filter(
            UserSubscription.user_id == user_id,
            UserSubscription.status == 'active'
        ).first()
        
        if not subscription:
            # 返回免费用户权限
            permissions = self._get_free_user_permissions()
        else:
            # 获取订阅用户权限
            permissions = self._get_subscription_permissions(subscription)
        
        # 缓存权限信息
        redis_client.setex(cache_key, self.cache_ttl, json.dumps(permissions))
        
        # 更新数据库缓存表
        self._update_permission_cache(user_id, permissions)
        
        return permissions
    
    def check_permission(self, user_id: int, permission_code: str, 
                        resource_data: Dict[str, Any] = None) -> Dict[str, Any]:
        """检查用户权限"""
        permissions = self.get_user_permissions(user_id)
        
        # 记录权限检查日志
        self._log_permission_usage(
            user_id, permission_code, 'check', 
            resource_data, 'checking'
        )
        
        # 基础功能权限检查
        if permission_code not in permissions.get('features', {}):
            result = {
                'allowed': False,
                'reason': 'feature_not_available',
                'message': f'Feature {permission_code} not available in current plan'
            }
            self._log_permission_usage(
                user_id, permission_code, 'check', 
                resource_data, 'denied'
            )
            return result
        
        # 积分消耗检查
        if permission_code in ['nano_banana', 'veo3_video', 'sticker']:
            credits_required = self._get_credits_required(permission_code, resource_data)
            if not self._check_credits_availability(user_id, credits_required):
                result = {
                    'allowed': False,
                    'reason': 'insufficient_credits',
                    'message': f'Insufficient credits. Required: {credits_required}'
                }
                self._log_permission_usage(
                    user_id, permission_code, 'check', 
                    resource_data, 'denied'
                )
                return result
        
        # 使用限制检查
        if not self._check_usage_limits(user_id, permission_code, resource_data):
            result = {
                'allowed': False,
                'reason': 'usage_limit_exceeded',
                'message': f'Usage limit exceeded for {permission_code}'
            }
            self._log_permission_usage(
                user_id, permission_code, 'check', 
                resource_data, 'denied'
            )
            return result
        
        # 权限检查通过
        result = {
            'allowed': True,
            'credits_required': self._get_credits_required(permission_code, resource_data),
            'priority_level': permissions.get('priority', 'normal')
        }
        
        self._log_permission_usage(
            user_id, permission_code, 'check', 
            resource_data, 'allowed'
        )
        
        return result
    
    def consume_permission(self, user_id: int, permission_code: str, 
                          resource_data: Dict[str, Any] = None) -> Dict[str, Any]:
        """消费权限（扣除积分等）"""
        # 先检查权限
        permission_check = self.check_permission(user_id, permission_code, resource_data)
        if not permission_check['allowed']:
            return permission_check
        
        # 消费积分
        credits_required = permission_check.get('credits_required', 0)
        if credits_required > 0:
            from app.services.subscription_service import SubscriptionService
            subscription_service = SubscriptionService(self.db)
            
            if not subscription_service.consume_credits(user_id, credits_required, permission_code):
                result = {
                    'success': False,
                    'reason': 'credit_consumption_failed',
                    'message': 'Failed to consume credits'
                }
                self._log_permission_usage(
                    user_id, permission_code, 'consume', 
                    resource_data, 'failed'
                )
                return result
        
        # 记录使用日志
        self._log_permission_usage(
            user_id, permission_code, 'consume', 
            resource_data, 'consumed'
        )
        
        # 更新使用统计
        self._update_usage_stats(user_id, permission_code, resource_data)
        
        return {
            'success': True,
            'credits_consumed': credits_required,
            'priority_level': permission_check.get('priority_level', 'normal')
        }
    
    def _get_subscription_permissions(self, subscription: UserSubscription) -> Dict[str, Any]:
        """获取订阅用户权限"""
        plan = subscription.plan
        
        # 获取计划的所有权限
        role_permissions = self.db.query(RolePermission).filter(
            RolePermission.plan_id == plan.id,
            RolePermission.is_enabled == True
        ).all()
        
        permissions = {
            'plan_code': plan.plan_code,
            'plan_name': plan.plan_name,
            'features': {},
            'limits': {},
            'priority': 'normal'
        }
        
        for rp in role_permissions:
            permission = rp.permission
            if permission.category == 'feature':
                permissions['features'][permission.permission_code] = True
            elif permission.category == 'limit':
                permissions['limits'][permission.permission_code] = rp.permission_value
            elif permission.category == 'priority':
                permissions['priority'] = rp.permission_value.get('level', 'normal')
        
        # 添加积分信息
        permissions['credits'] = {
            'monthly_quota': plan.credits_monthly,
            'current_available': self._get_user_available_credits(subscription.user_id)
        }
        
        return permissions
    
    def _get_free_user_permissions(self) -> Dict[str, Any]:
        """获取免费用户权限"""
        return {
            'plan_code': 'free',
            'plan_name': 'Free Plan',
            'features': {
                'nano_banana': True,  # 免费用户可能有限制使用
            },
            'limits': {
                'daily_usage': 3,  # 每日3次免费使用
                'image_size': 'small'  # 只能生成小尺寸图片
            },
            'credits': {
                'monthly_quota': 0,
                'current_available': 0
            },
            'priority': 'low'
        }
    
    def _get_credits_required(self, permission_code: str, resource_data: Dict[str, Any] = None) -> int:
        """获取功能所需积分"""
        credit_map = {
            'nano_banana': 14,
            'veo3_video': 160,
            'sticker': 14
        }
        
        base_credits = credit_map.get(permission_code, 0)
        
        # 根据资源数据调整积分消耗
        if resource_data:
            if permission_code == 'nano_banana':
                # 根据图片尺寸调整积分
                size_multiplier = {
                    'small': 1.0,
                    'medium': 1.5,
                    'large': 2.0
                }.get(resource_data.get('size', 'medium'), 1.0)
                base_credits = int(base_credits * size_multiplier)
            
            elif permission_code == 'veo3_video':
                # 根据视频时长调整积分
                duration = resource_data.get('duration', 5)  # 默认5秒
                base_credits = int(base_credits * (duration / 5))
        
        return base_credits
    
    def _check_credits_availability(self, user_id: int, credits_required: int) -> bool:
        """检查积分是否足够"""
        from app.models.credit import UserCredit
        
        user_credit = self.db.query(UserCredit).filter(
            UserCredit.user_id == user_id
        ).first()
        
        if not user_credit:
            return credits_required == 0
        
        return user_credit.available_credits >= credits_required
    
    def _check_usage_limits(self, user_id: int, permission_code: str, 
                           resource_data: Dict[str, Any] = None) -> bool:
        """检查使用限制"""
        permissions = self.get_user_permissions(user_id)
        limits = permissions.get('limits', {})
        
        # 检查每日使用限制
        if 'daily_usage' in limits:
            daily_limit = limits['daily_usage']
            today_usage = self._get_today_usage_count(user_id, permission_code)
            if today_usage >= daily_limit:
                return False
        
        # 检查并发限制
        if 'concurrent_jobs' in limits:
            concurrent_limit = limits['concurrent_jobs']
            current_jobs = self._get_running_jobs_count(user_id)
            if current_jobs >= concurrent_limit:
                return False
        
        return True
    
    def _get_today_usage_count(self, user_id: int, permission_code: str) -> int:
        """获取今日使用次数"""
        from datetime import date
        today = date.today()
        
        count = self.db.query(PermissionUsageLog).filter(
            PermissionUsageLog.user_id == user_id,
            PermissionUsageLog.permission_code == permission_code,
            PermissionUsageLog.action == 'consume',
            PermissionUsageLog.result == 'consumed',
            PermissionUsageLog.created_at >= today
        ).count()
        
        return count
    
    def _get_running_jobs_count(self, user_id: int) -> int:
        """获取正在运行的任务数量"""
        # 这里需要根据实际的任务系统实现
        # 可能需要查询任务队列或任务状态表
        return 0
    
    def _log_permission_usage(self, user_id: int, permission_code: str, action: str,
                             resource_data: Dict[str, Any], result: str):
        """记录权限使用日志"""
        log = PermissionUsageLog(
            user_id=user_id,
            permission_code=permission_code,
            action=action,
            resource_type=resource_data.get('type') if resource_data else None,
            resource_id=resource_data.get('id') if resource_data else None,
            result=result,
            metadata=resource_data or {}
        )
        self.db.add(log)
        self.db.commit()
    
    def _update_permission_cache(self, user_id: int, permissions: Dict[str, Any]):
        """更新权限缓存表"""
        cache_record = self.db.query(UserPermissionCache).filter(
            UserPermissionCache.user_id == user_id
        ).first()
        
        expires_at = datetime.utcnow() + timedelta(seconds=self.cache_ttl)
        
        if cache_record:
            cache_record.permissions = permissions
            cache_record.expires_at = expires_at
            cache_record.updated_at = datetime.utcnow()
        else:
            cache_record = UserPermissionCache(
                user_id=user_id,
                permissions=permissions,
                expires_at=expires_at
            )
            self.db.add(cache_record)
        
        self.db.commit()
    
    def refresh_user_permissions(self, user_id: int):
        """刷新用户权限缓存"""
        cache_key = f"user_permissions:{user_id}"
        redis_client.delete(cache_key)
        return self.get_user_permissions(user_id, force_refresh=True)
    
    def grant_temporary_permission(self, user_id: int, permission_code: str, 
                                  duration_hours: int = 24):
        """授予临时权限"""
        cache_key = f"temp_permission:{user_id}:{permission_code}"
        temp_permission = {
            'granted_at': datetime.utcnow().isoformat(),
            'expires_at': (datetime.utcnow() + timedelta(hours=duration_hours)).isoformat(),
            'permission_code': permission_code
        }
        
        redis_client.setex(
            cache_key, 
            duration_hours * 3600, 
            json.dumps(temp_permission)
        )
        
        # 刷新用户权限缓存
        self.refresh_user_permissions(user_id)
```

#### 3.2 权限装饰器
```python
# decorators/permission_required.py
from functools import wraps
from fastapi import HTTPException, Depends
from app.core.dependencies import get_current_user
from app.services.permission_service import PermissionService

def permission_required(permission_code: str, consume: bool = False):
    """权限检查装饰器"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            # 获取当前用户
            current_user = kwargs.get('current_user')
            if not current_user:
                raise HTTPException(status_code=401, detail="Authentication required")
            
            # 获取数据库会话
            db = kwargs.get('db')
            if not db:
                raise HTTPException(status_code=500, detail="Database session not available")
            
            # 检查权限
            permission_service = PermissionService(db)
            
            if consume:
                # 消费权限
                result = permission_service.consume_permission(
                    current_user.id, 
                    permission_code,
                    kwargs.get('resource_data')
                )
                if not result.get('success', False):
                    raise HTTPException(
                        status_code=403, 
                        detail=result.get('message', 'Permission denied')
                    )
            else:
                # 仅检查权限
                result = permission_service.check_permission(
                    current_user.id, 
                    permission_code,
                    kwargs.get('resource_data')
                )
                if not result.get('allowed', False):
                    raise HTTPException(
                        status_code=403, 
                        detail=result.get('message', 'Permission denied')
                    )
            
            # 将权限检查结果添加到kwargs中
            kwargs['permission_result'] = result
            
            return await func(*args, **kwargs)
        return wrapper
    return decorator
```

### 4. API 接口实现

#### 4.1 权限检查API
```python
# api/v1/permissions.py
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from app.core.dependencies import get_db, get_current_user
from app.services.permission_service import PermissionService
from app.schemas.permission import PermissionCheck, PermissionResult

router = APIRouter(prefix="/permissions", tags=["permissions"])

@router.get("/my-permissions")
async def get_my_permissions(
    current_user = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """获取当前用户权限"""
    permission_service = PermissionService(db)
    permissions = permission_service.get_user_permissions(current_user.id)
    return permissions

@router.post("/check", response_model=PermissionResult)
async def check_permission(
    permission_check: PermissionCheck,
    current_user = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """检查特定权限"""
    permission_service = PermissionService(db)
    result = permission_service.check_permission(
        current_user.id,
        permission_check.permission_code,
        permission_check.resource_data
    )
    return result

@router.post("/refresh")
async def refresh_permissions(
    current_user = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """刷新用户权限缓存"""
    permission_service = PermissionService(db)
    permissions = permission_service.refresh_user_permissions(current_user.id)
    return {"status": "success", "permissions": permissions}
```

#### 4.2 功能API使用权限装饰器
```python
# api/v1/ai_features.py
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from app.core.dependencies import get_db, get_current_user
from app.decorators.permission_required import permission_required
from app.schemas.ai_features import ImageGenerationRequest, VideoGenerationRequest

router = APIRouter(prefix="/ai-features", tags=["ai-features"])

@router.post("/generate-image")
@permission_required("nano_banana", consume=True)
async def generate_image(
    request: ImageGenerationRequest,
    current_user = Depends(get_current_user),
    db: Session = Depends(get_db),
    permission_result: dict = None
):
    """生成图片 - 需要nano_banana权限"""
    # 获取优先级
    priority = permission_result.get('priority_level', 'normal')
    
    # 调用图片生成服务
    # 根据优先级安排任务队列
    result = await generate_image_task.apply_async(
        args=[request.dict()],
        priority=get_priority_value(priority)
    )
    
    return {
        "task_id": result.id,
        "status": "queued",
        "priority": priority,
        "credits_consumed": permission_result.get('credits_consumed', 0)
    }

@router.post("/generate-video")
@permission_required("veo3_video", consume=True)
async def generate_video(
    request: VideoGenerationRequest,
    current_user = Depends(get_current_user),
    db: Session = Depends(get_db),
    permission_result: dict = None
):
    """生成视频 - 需要veo3_video权限"""
    priority = permission_result.get('priority_level', 'normal')
    
    # 调用视频生成服务
    result = await generate_video_task.apply_async(
        args=[request.dict()],
        priority=get_priority_value(priority)
    )
    
    return {
        "task_id": result.id,
        "status": "queued", 
        "priority": priority,
        "credits_consumed": permission_result.get('credits_consumed', 0)
    }

@router.post("/batch-process")
@permission_required("batch_processing", consume=False)
async def batch_process(
    request: BatchProcessRequest,
    current_user = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """批量处理 - 需要batch_processing权限"""
    # 批量处理逻辑
    pass

def get_priority_value(priority_level: str) -> int:
    """将优先级转换为数值"""
    priority_map = {
        'low': 1,
        'normal': 5,
        'high': 8,
        'highest': 9,
        'vip': 10
    }
    return priority_map.get(priority_level, 5)
```

### 5. 前端权限管理

#### 5.1 权限Context
```jsx
// contexts/PermissionContext.jsx
import React, { createContext, useContext, useState, useEffect } from 'react';
import { useAuth } from './AuthContext';
import { permissionAPI } from '../services/api';

const PermissionContext = createContext();

export const usePermissions = () => {
  const context = useContext(PermissionContext);
  if (!context) {
    throw new Error('usePermissions must be used within PermissionProvider');
  }
  return context;
};

export const PermissionProvider = ({ children }) => {
  const { user, isAuthenticated } = useAuth();
  const [permissions, setPermissions] = useState(null);
  const [loading, setLoading] = useState(false);

  const fetchPermissions = async () => {
    if (!isAuthenticated) {
      setPermissions(null);
      return;
    }

    setLoading(true);
    try {
      const response = await permissionAPI.getMyPermissions();
      setPermissions(response.data);
    } catch (error) {
      console.error('Failed to fetch permissions:', error);
      setPermissions(null);
    } finally {
      setLoading(false);
    }
  };

  const checkPermission = async (permissionCode, resourceData = null) => {
    try {
      const response = await permissionAPI.checkPermission({
        permission_code: permissionCode,
        resource_data: resourceData
      });
      return response.data;
    } catch (error) {
      console.error('Permission check failed:', error);
      return { allowed: false, reason: 'check_failed' };
    }
  };

  const hasFeature = (featureCode) => {
    if (!permissions) return false;
    return permissions.features?.[featureCode] === true;
  };

  const getCreditsInfo = () => {
    return permissions?.credits || { monthly_quota: 0, current_available: 0 };
  };

  const getPriorityLevel = () => {
    return permissions?.priority || 'normal';
  };

  const refreshPermissions = async () => {
    await permissionAPI.refreshPermissions();
    await fetchPermissions();
  };

  useEffect(() => {
    fetchPermissions();
  }, [isAuthenticated, user]);

  const value = {
    permissions,
    loading,
    hasFeature,
    checkPermission,
    getCreditsInfo,
    getPriorityLevel,
    refreshPermissions,
    fetchPermissions
  };

  return (
    <PermissionContext.Provider value={value}>
      {children}
    </PermissionContext.Provider>
  );
};
```

#### 5.2 权限保护组件
```jsx
// components/PermissionGuard.jsx
import React from 'react';
import { usePermissions } from '../contexts/PermissionContext';
import { useTranslation } from 'react-i18next';

const PermissionGuard = ({ 
  feature, 
  children, 
  fallback = null,
  showUpgrade = true 
}) => {
  const { hasFeature, permissions, loading } = usePermissions();
  const { t } = useTranslation();

  if (loading) {
    return <div className="permission-loading">Loading permissions...</div>;
  }

  if (!hasFeature(feature)) {
    if (fallback) {
      return fallback;
    }

    return (
      <div className="permission-denied">
        <div className="permission-message">
          <h3>{t('permissions.featureNotAvailable')}</h3>
          <p>{t('permissions.upgradeRequired', { feature: t(`features.${feature}`) })}</p>
          {showUpgrade && (
            <button 
              className="upgrade-button"
              onClick={() => window.location.href = '/pricing'}
            >
              {t('permissions.upgradePlan')}
            </button>
          )}
        </div>
      </div>
    );
  }

  return children;
};

export default PermissionGuard;
```

#### 5.3 积分显示组件
```jsx
// components/CreditsDisplay.jsx
import React from 'react';
import { usePermissions } from '../contexts/PermissionContext';
import { useTranslation } from 'react-i18next';

const CreditsDisplay = () => {
  const { getCreditsInfo, permissions } = usePermissions();
  const { t } = useTranslation();
  const credits = getCreditsInfo();

  const usagePercentage = credits.monthly_quota > 0 
    ? ((credits.monthly_quota - credits.current_available) / credits.monthly_quota) * 100 
    : 0;

  return (
    <div className="credits-display">
      <div className="credits-header">
        <h4>{t('dashboard.credits')}</h4>
        <span className="plan-badge">{permissions?.plan_name}</span>
      </div>
      
      <div className="credits-info">
        <div className="credits-numbers">
          <span className="available">{credits.current_available}</span>
          <span className="separator">/</span>
          <span className="total">{credits.monthly_quota}</span>
        </div>
        
        <div className="credits-progress">
          <div className="progress-bar">
            <div 
              className="progress-fill"
              style={{ width: `${usagePercentage}%` }}
            />
          </div>
          <span className="progress-text">
            {Math.round(usagePercentage)}% {t('common.used')}
          </span>
        </div>
      </div>
      
      {credits.current_available < 50 && (
        <div className="low-credits-warning">
          <p>{t('credits.lowBalance')}</p>
          <button 
            className="upgrade-button"
            onClick={() => window.location.href = '/pricing'}
          >
            {t('credits.addMore')}
          </button>
        </div>
      )}
    </div>
  );
};

export default CreditsDisplay;
```

### 6. 权限管理后台

#### 6.1 权限配置API
```python
# api/v1/admin/permissions.py
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from app.core.dependencies import get_db, get_admin_user
from app.services.permission_service import PermissionService
from app.models.permission import Permission, RolePermission
from app.schemas.admin import PermissionCreate, RolePermissionUpdate

router = APIRouter(prefix="/admin/permissions", tags=["admin-permissions"])

@router.get("/")
async def list_permissions(
    admin_user = Depends(get_admin_user),
    db: Session = Depends(get_db)
):
    """获取所有权限列表"""
    permissions = db.query(Permission).filter(Permission.is_active == True).all()
    return permissions

@router.post("/")
async def create_permission(
    permission_data: PermissionCreate,
    admin_user = Depends(get_admin_user),
    db: Session = Depends(get_db)
):
    """创建新权限"""
    permission = Permission(**permission_data.dict())
    db.add(permission)
    db.commit()
    db.refresh(permission)
    return permission

@router.get("/plans/{plan_id}/permissions")
async def get_plan_permissions(
    plan_id: int,
    admin_user = Depends(get_admin_user),
    db: Session = Depends(get_db)
):
    """获取计划的权限配置"""
    role_permissions = db.query(RolePermission).filter(
        RolePermission.plan_id == plan_id
    ).all()
    return role_permissions

@router.put("/plans/{plan_id}/permissions")
async def update_plan_permissions(
    plan_id: int,
    permissions_update: List[RolePermissionUpdate],
    admin_user = Depends(get_admin_user),
    db: Session = Depends(get_db)
):
    """更新计划的权限配置"""
    # 删除现有权限配置
    db.query(RolePermission).filter(RolePermission.plan_id == plan_id).delete()
    
    # 添加新的权限配置
    for perm_update in permissions_update:
        role_permission = RolePermission(
            plan_id=plan_id,
            permission_id=perm_update.permission_id,
            permission_value=perm_update.permission_value,
            is_enabled=perm_update.is_enabled
        )
        db.add(role_permission)
    
    db.commit()
    return {"status": "success", "message": "Permissions updated"}
```

#### 6.2 权限管理前端
```jsx
// components/admin/PermissionManager.jsx
import React, { useState, useEffect } from 'react';
import { adminAPI } from '../../services/api';

const PermissionManager = () => {
  const [plans, setPlans] = useState([]);
  const [permissions, setPermissions] = useState([]);
  const [selectedPlan, setSelectedPlan] = useState(null);
  const [planPermissions, setPlanPermissions] = useState([]);

  useEffect(() => {
    fetchPlans();
    fetchPermissions();
  }, []);

  const fetchPlans = async () => {
    try {
      const response = await adminAPI.getSubscriptionPlans();
      setPlans(response.data);
    } catch (error) {
      console.error('Failed to fetch plans:', error);
    }
  };

  const fetchPermissions = async () => {
    try {
      const response = await adminAPI.getPermissions();
      setPermissions(response.data);
    } catch (error) {
      console.error('Failed to fetch permissions:', error);
    }
  };

  const fetchPlanPermissions = async (planId) => {
    try {
      const response = await adminAPI.getPlanPermissions(planId);
      setPlanPermissions(response.data);
    } catch (error) {
      console.error('Failed to fetch plan permissions:', error);
    }
  };

  const handlePlanSelect = (plan) => {
    setSelectedPlan(plan);
    fetchPlanPermissions(plan.id);
  };

  const updatePermission = async (permissionId, enabled, value) => {
    try {
      const updatedPermissions = planPermissions.map(p => 
        p.permission_id === permissionId 
          ? { ...p, is_enabled: enabled, permission_value: value }
          : p
      );
      
      await adminAPI.updatePlanPermissions(selectedPlan.id, updatedPermissions);
      setPlanPermissions(updatedPermissions);
    } catch (error) {
      console.error('Failed to update permission:', error);
    }
  };

  return (
    <div className="permission-manager">
      <div className="plans-sidebar">
        <h3>Subscription Plans</h3>
        {plans.map(plan => (
          <div 
            key={plan.id}
            className={`plan-item ${selectedPlan?.id === plan.id ? 'selected' : ''}`}
            onClick={() => handlePlanSelect(plan)}
          >
            <h4>{plan.plan_name}</h4>
            <p>${plan.price_monthly}/month</p>
          </div>
        ))}
      </div>

      <div className="permissions-content">
        {selectedPlan ? (
          <div>
            <h2>Permissions for {selectedPlan.plan_name}</h2>
            <div className="permissions-grid">
              {permissions.map(permission => {
                const planPerm = planPermissions.find(p => p.permission_id === permission.id);
                return (
                  <div key={permission.id} className="permission-card">
                    <div className="permission-header">
                      <h4>{permission.permission_name}</h4>
                      <label className="toggle">
                        <input
                          type="checkbox"
                          checked={planPerm?.is_enabled || false}
                          onChange={(e) => updatePermission(
                            permission.id, 
                            e.target.checked, 
                            planPerm?.permission_value
                          )}
                        />
                        <span className="slider"></span>
                      </label>
                    </div>
                    <p>{permission.description}</p>
                    
                    {planPerm?.is_enabled && permission.category === 'limit' && (
                      <div className="permission-config">
                        <label>Limit Value:</label>
                        <input
                          type="number"
                          value={planPerm.permission_value?.limit || 0}
                          onChange={(e) => updatePermission(
                            permission.id,
                            true,
                            { ...planPerm.permission_value, limit: parseInt(e.target.value) }
                          )}
                        />
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </div>
        ) : (
          <div className="no-plan-selected">
            <p>Select a plan to manage permissions</p>
          </div>
        )}
      </div>
    </div>
  );
};

export default PermissionManager;
```

### 7. 权限数据初始化

#### 7.1 权限数据SQL
```sql
-- 插入基础权限
INSERT INTO permissions (permission_code, permission_name, permission_name_en, description, category) VALUES
('nano_banana', 'Nano Banana 图片生成', 'Nano Banana Image Generation', 'Generate images using Nano Banana AI', 'feature'),
('veo3_video', 'Veo3 视频生成', 'Veo3 Video Generation', 'Generate videos using Veo3 AI', 'feature'),
('sticker', '贴纸制作', 'Sticker Creation', 'Create stickers with AI', 'feature'),
('batch_processing', '批量处理', 'Batch Processing', 'Process multiple items at once', 'feature'),
('professional_canvas', '专业画布编辑', 'Professional Canvas Editing', 'Advanced canvas editing tools', 'feature'),
('daily_usage_limit', '每日使用限制', 'Daily Usage Limit', 'Maximum daily usage count', 'limit'),
('concurrent_jobs', '并发任务限制', 'Concurrent Jobs Limit', 'Maximum concurrent processing jobs', 'limit'),
('priority_queue', '优先级队列', 'Priority Queue', 'Task processing priority level', 'priority');

-- 为入门版配置权限
INSERT INTO role_permissions (plan_id, permission_id, permission_value, is_enabled) 
SELECT 
    sp.id, 
    p.id,
    CASE 
        WHEN p.permission_code = 'daily_usage_limit' THEN '{"limit": 100}'::jsonb
        WHEN p.permission_code = 'concurrent_jobs' THEN '{"limit": 2}'::jsonb
        WHEN p.permission_code = 'priority_queue' THEN '{"level": "normal"}'::jsonb
        ELSE '{}'::jsonb
    END,
    CASE 
        WHEN p.permission_code IN ('nano_banana', 'veo3_video', 'sticker') THEN true
        WHEN p.permission_code IN ('batch_processing', 'professional_canvas') THEN false
        ELSE true
    END
FROM subscription_plans sp, permissions p 
WHERE sp.plan_code = 'starter';

-- 为进阶版配置权限
INSERT INTO role_permissions (plan_id, permission_id, permission_value, is_enabled)
SELECT 
    sp.id, 
    p.id,
    CASE 
        WHEN p.permission_code = 'daily_usage_limit' THEN '{"limit": 500}'::jsonb
        WHEN p.permission_code = 'concurrent_jobs' THEN '{"limit": 5}'::jsonb
        WHEN p.permission_code = 'priority_queue' THEN '{"level": "high"}'::jsonb
        ELSE '{}'::jsonb
    END,
    CASE 
        WHEN p.permission_code IN ('nano_banana', 'veo3_video', 'sticker', 'batch_processing') THEN true
        WHEN p.permission_code = 'professional_canvas' THEN false
        ELSE true
    END
FROM subscription_plans sp, permissions p 
WHERE sp.plan_code = 'advanced';

-- 为专业版配置权限
INSERT INTO role_permissions (plan_id, permission_id, permission_value, is_enabled)
SELECT 
    sp.id, 
    p.id,
    CASE 
        WHEN p.permission_code = 'daily_usage_limit' THEN '{"limit": -1}'::jsonb  -- -1 表示无限制
        WHEN p.permission_code = 'concurrent_jobs' THEN '{"limit": 10}'::jsonb
        WHEN p.permission_code = 'priority_queue' THEN '{"level": "highest"}'::jsonb
        ELSE '{}'::jsonb
    END,
    true  -- 专业版开启所有功能
FROM subscription_plans sp, permissions p 
WHERE sp.plan_code = 'professional';

-- 为买断版配置权限
INSERT INTO role_permissions (plan_id, permission_id, permission_value, is_enabled)
SELECT 
    sp.id, 
    p.id,
    CASE 
        WHEN p.permission_code = 'daily_usage_limit' THEN '{"limit": -1}'::jsonb
        WHEN p.permission_code = 'concurrent_jobs' THEN '{"limit": 20}'::jsonb
        WHEN p.permission_code = 'priority_queue' THEN '{"level": "vip"}'::jsonb
        ELSE '{}'::jsonb
    END,
    true  -- 买断版开启所有功能
FROM subscription_plans sp, permissions p 
WHERE sp.plan_code = 'lifetime';
```

### 8. 监控和分析

#### 8.1 权限使用统计
```python
# services/permission_analytics.py
from sqlalchemy.orm import Session
from sqlalchemy import func
from app.models.permission import PermissionUsageLog
from datetime import datetime, timedelta

class PermissionAnalytics:
    def __init__(self, db: Session):
        self.db = db
    
    def get_feature_usage_stats(self, days: int = 30) -> Dict[str, Any]:
        """获取功能使用统计"""
        start_date = datetime.utcnow() - timedelta(days=days)
        
        stats = self.db.query(
            PermissionUsageLog.permission_code,
            func.count(PermissionUsageLog.id).label('usage_count'),
            func.count(func.distinct(PermissionUsageLog.user_id)).label('unique_users')
        ).filter(
            PermissionUsageLog.created_at >= start_date,
            PermissionUsageLog.action == 'consume',
            PermissionUsageLog.result == 'consumed'
        ).group_by(PermissionUsageLog.permission_code).all()
        
        return [
            {
                'feature': stat.permission_code,
                'usage_count': stat.usage_count,
                'unique_users': stat.unique_users
            }
            for stat in stats
        ]
    
    def get_user_permission_violations(self, days: int = 7) -> List[Dict[str, Any]]:
        """获取权限违规记录"""
        start_date = datetime.utcnow() - timedelta(days=days)
        
        violations = self.db.query(PermissionUsageLog).filter(
            PermissionUsageLog.created_at >= start_date,
            PermissionUsageLog.result == 'denied'
        ).all()
        
        return [
            {
                'user_id': v.user_id,
                'permission_code': v.permission_code,
                'reason': v.metadata.get('reason'),
                'created_at': v.created_at
            }
            for v in violations
        ]
```

这个会员权限管理实现方案提供了完整的权限控制系统，包括数据库设计、后端服务、前端组件、管理后台和监控分析，可以有效管理不同等级用户的功能访问权限和使用限制。
