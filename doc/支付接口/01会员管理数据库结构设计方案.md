# 01会员管理数据库结构设计方案

## 基于 Nano Banana AI 的会员管理分析

### 1. Nano Banana AI 会员体系分析

根据 [Nano Banana AI 定价页面](https://nanobananas.site/zh/pricing) 分析，该平台采用以下会员体系：

#### 1.1 会员等级
- **入门版**: $6.9/月，560积分/月
- **进阶版**: $19.9/月，1,680积分/月  
- **专业版**: $29.9/月，4,200积分/月
- **买断版**: $399，4,200积分/月，终身使用

#### 1.2 积分消耗模式
- Nano Banana: 14积分/张
- Veo3视频: 160积分/个
- 贴纸制作: 14积分/张（9种样式）

#### 1.3 功能权限分级
- 基础功能：全部风格模板、所有编辑工具、多种AI模型
- 高级功能：批量处理、专业画布编辑、优先处理队列
- 专属服务：专属客户经理（买断版）

## 2. 数据库结构设计

### 2.1 用户表 (users)
```sql
/* 基于 Supabase auth.users 表结构，使用 UUID 作为主键 */
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    encrypted_password VARCHAR(255),
    email_confirmed_at TIMESTAMP WITH TIME ZONE,
    invited_at TIMESTAMP WITH TIME ZONE,
    confirmation_token VARCHAR(255),
    confirmation_sent_at TIMESTAMP WITH TIME ZONE,
    recovery_token VARCHAR(255),
    recovery_sent_at TIMESTAMP WITH TIME ZONE,
    email_change_token_new VARCHAR(255),
    email_change VARCHAR(255),
    email_change_sent_at TIMESTAMP WITH TIME ZONE,
    last_sign_in_at TIMESTAMP WITH TIME ZONE,
    raw_app_meta_data JSONB,
    raw_user_meta_data JSONB,
    is_super_admin BOOLEAN,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    phone VARCHAR(15),
    phone_confirmed_at TIMESTAMP WITH TIME ZONE,
    phone_change VARCHAR(15),
    phone_change_token VARCHAR(255),
    phone_change_sent_at TIMESTAMP WITH TIME ZONE,
    confirmed_at TIMESTAMP WITH TIME ZONE,
    email_change_token_current VARCHAR(255),
    email_change_confirm_status SMALLINT,
    banned_until TIMESTAMP WITH TIME ZONE,
    reauthentication_token VARCHAR(255),
    reauthentication_sent_at TIMESTAMP WITH TIME ZONE,
    is_sso_user BOOLEAN DEFAULT false,
    deleted_at TIMESTAMP WITH TIME ZONE,
    is_anonymous BOOLEAN DEFAULT false
);
```

### 2.2 会员套餐表 (pay_subscription_plans)
```sql
CREATE TABLE pay_subscription_plans (
    id BIGSERIAL PRIMARY KEY,
    plan_code VARCHAR(50) UNIQUE NOT NULL, /* starter, advanced, professional, lifetime */
    plan_name VARCHAR(100) NOT NULL,
    plan_name_en VARCHAR(100) NOT NULL,
    description TEXT,
    description_en TEXT,
    price_monthly DECIMAL(10,2),
    price_yearly DECIMAL(10,2),
    credits_monthly INTEGER NOT NULL, /* 月度积分额度 */
    features JSONB NOT NULL, /* 功能列表 */
    is_active BOOLEAN DEFAULT true,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2.3 用户订阅表 (pay_user_subscriptions)
```sql
CREATE TABLE pay_user_subscriptions (
    id BIGSERIAL PRIMARY KEY,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    plan_id BIGINT REFERENCES pay_subscription_plans(id),
    subscription_type VARCHAR(20) NOT NULL, /* monthly, yearly, lifetime */
    status VARCHAR(20) DEFAULT 'active', /* active, cancelled, expired, pending */
    start_date TIMESTAMP WITH TIME ZONE NOT NULL,
    end_date TIMESTAMP WITH TIME ZONE,
    auto_renew BOOLEAN DEFAULT true,
    payment_method VARCHAR(50), /* paypal, stripe, alipay */
    external_subscription_id VARCHAR(255), /* PayPal订阅ID */
    trial_end_date TIMESTAMP WITH TIME ZONE,
    cancelled_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2.4 积分账户表 (pay_user_credits)
```sql
CREATE TABLE pay_user_credits (
    id BIGSERIAL PRIMARY KEY,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE UNIQUE,
    total_credits INTEGER DEFAULT 0, /* 总积分 */
    used_credits INTEGER DEFAULT 0, /* 已使用积分 */
    available_credits INTEGER DEFAULT 0, /* 可用积分 */
    monthly_quota INTEGER DEFAULT 0, /* 月度配额 */
    quota_reset_date TIMESTAMP WITH TIME ZONE, /* 配额重置日期 */
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2.5 积分交易记录表 (pay_credit_transactions)
```sql
CREATE TABLE pay_credit_transactions (
    id BIGSERIAL PRIMARY KEY,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    transaction_type VARCHAR(20) NOT NULL, /* earn, spend, refund, expire */
    amount INTEGER NOT NULL, /* 正数为获得，负数为消费 */
    balance_after INTEGER NOT NULL, /* 交易后余额 */
    source VARCHAR(50) NOT NULL, /* subscription, purchase, refund, usage */
    source_id VARCHAR(255), /* 关联的订单ID或使用记录ID */
    description TEXT,
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2.6 功能使用记录表 (pay_feature_usage)
```sql
CREATE TABLE pay_feature_usage (
    id BIGSERIAL PRIMARY KEY,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    feature_type VARCHAR(50) NOT NULL, /* nano_banana, veo3_video, sticker */
    credits_consumed INTEGER NOT NULL,
    usage_data JSONB, /* 使用详情（图片尺寸、视频时长等） */
    status VARCHAR(20) DEFAULT 'completed', /* pending, completed, failed */
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    completed_at TIMESTAMP WITH TIME ZONE
);
```

### 2.7 支付订单表 (pay_payment_orders)
```sql
CREATE TABLE pay_payment_orders (
    id BIGSERIAL PRIMARY KEY,
    order_no VARCHAR(100) UNIQUE NOT NULL,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    plan_id BIGINT REFERENCES pay_subscription_plans(id),
    amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'USD',
    payment_method VARCHAR(50) NOT NULL, /* paypal, stripe */
    payment_status VARCHAR(20) DEFAULT 'pending', /* pending, completed, failed, cancelled, refunded */
    external_order_id VARCHAR(255), /* PayPal订单ID */
    external_payment_id VARCHAR(255), /* PayPal支付ID */
    payment_data JSONB, /* 支付平台返回的详细数据 */
    paid_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2.8 退款记录表 (pay_refunds)
```sql
CREATE TABLE pay_refunds (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT REFERENCES pay_payment_orders(id),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    refund_amount DECIMAL(10,2) NOT NULL,
    refund_reason TEXT,
    refund_status VARCHAR(20) DEFAULT 'pending', /* pending, completed, failed */
    external_refund_id VARCHAR(255), /* PayPal退款ID */
    processed_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## 3. 索引优化

```sql
/* 用户相关索引 */
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_created_at ON users(created_at);

/* 订阅相关索引 */
CREATE INDEX idx_pay_user_subscriptions_user_id ON pay_user_subscriptions(user_id);
CREATE INDEX idx_pay_user_subscriptions_status ON pay_user_subscriptions(status);
CREATE INDEX idx_pay_user_subscriptions_end_date ON pay_user_subscriptions(end_date);

/* 积分相关索引 */
CREATE INDEX idx_pay_credit_transactions_user_id ON pay_credit_transactions(user_id);
CREATE INDEX idx_pay_credit_transactions_created_at ON pay_credit_transactions(created_at);
CREATE INDEX idx_pay_feature_usage_user_id ON pay_feature_usage(user_id);
CREATE INDEX idx_pay_feature_usage_created_at ON pay_feature_usage(created_at);

/* 支付相关索引 */
CREATE INDEX idx_pay_payment_orders_user_id ON pay_payment_orders(user_id);
CREATE INDEX idx_pay_payment_orders_status ON pay_payment_orders(payment_status);
CREATE INDEX idx_pay_payment_orders_created_at ON pay_payment_orders(created_at);
```

## 4. 数据初始化

### 4.1 套餐数据初始化
```sql
/* 初始化会员套餐数据 */
INSERT INTO pay_subscription_plans (plan_code, plan_name, plan_name_en, price_monthly, price_yearly, credits_monthly, features) VALUES
('starter', '入门版', 'Starter', 6.90, 69.00, 560, '{"nano_banana": true, "veo3_video": true, "sticker": true, "templates": "all", "editing_tools": "all", "ai_models": "multiple"}'),
('advanced', '进阶版', 'Advanced', 19.90, 199.00, 1680, '{"nano_banana": true, "veo3_video": true, "sticker": true, "templates": "all", "editing_tools": "all", "ai_models": "multiple", "batch_processing": true, "professional_canvas": true, "priority_queue": "normal"}'),
('professional', '专业版', 'Professional', 29.90, 299.00, 4200, '{"nano_banana": true, "veo3_video": true, "sticker": true, "templates": "all", "editing_tools": "all", "ai_models": "multiple", "batch_processing": true, "professional_canvas": true, "priority_queue": "high"}'),
('lifetime', '买断版', 'Lifetime', 399.00, 399.00, 4200, '{"nano_banana": true, "veo3_video": true, "sticker": true, "templates": "all", "editing_tools": "all", "ai_models": "multiple", "batch_processing": true, "professional_canvas": true, "priority_queue": "highest", "dedicated_manager": true}');
```

## 5. 触发器和函数

### 5.1 积分余额更新触发器
```sql
/* 积分余额更新函数 */
CREATE OR REPLACE FUNCTION update_credit_balance()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE pay_user_credits 
    SET 
        available_credits = total_credits - used_credits,
        updated_at = NOW()
    WHERE user_id = NEW.user_id;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

/* 积分交易后自动更新余额触发器 */
CREATE TRIGGER trigger_update_credit_balance
    AFTER INSERT ON pay_credit_transactions
    FOR EACH ROW
    EXECUTE FUNCTION update_credit_balance();
```

### 5.2 订阅状态更新函数
```sql
/* 检查并更新过期订阅状态函数 */
CREATE OR REPLACE FUNCTION check_subscription_expiry()
RETURNS void AS $$
BEGIN
    UPDATE pay_user_subscriptions 
    SET status = 'expired'
    WHERE status = 'active' 
    AND end_date < NOW()
    AND subscription_type != 'lifetime';
END;
$$ LANGUAGE plpgsql;
```

## 6. 数据安全和隐私

### 6.1 敏感数据加密
- 密码使用 bcrypt 哈希
- 支付信息不存储敏感数据，仅保存必要的标识符
- 个人信息遵循 GDPR 规范

### 6.2 数据备份策略
- 每日自动备份
- 异地备份存储
- 定期恢复测试

## 7. 性能优化建议

### 7.1 分区策略
- 按时间分区 pay_credit_transactions 表
- 按用户ID分区大表

### 7.2 缓存策略
- Redis 缓存用户会员状态
- 缓存积分余额信息
- 缓存套餐信息

## 8. 监控和报警

### 8.1 关键指标监控
- 订阅转化率
- 积分使用率
- 支付成功率
- 用户留存率

### 8.2 异常报警
- 支付失败率过高
- 积分异常消耗
- 订阅到期提醒
