# 服务器启动命令说明

## 服务器信息
- **服务器地址**: 54.89.140.250
- **SSH密钥**: /Users/a1/work/productmindai.pem
- **用户**: ec2-user
- **项目目录**: /home/ec2-user/nanobanana
- **域名**: https://nanobanana.gitagent.io

## 端口配置
- **前端端口**: 8889
- **后端端口**: 3002
- **Nginx代理**: 80/443 → 8889 (前端), /api → 3002 (后端)

## 完整重启流程

### 1. 连接服务器
```bash
ssh -i /Users/a1/work/productmindai.pem ec2-user@54.89.140.250
```

### 2. 进入项目目录
```bash
cd /home/ec2-user/nanobanana
```

### 3. 更新代码（如需要）
```bash
git pull origin main
```

### 4. 停止所有服务

#### 停止前端服务
```bash
# 方法1：停止npm进程
pkill -f "npm run dev"

# 方法2：停止netlify进程
pkill -f "netlify"

# 方法3：停止vite进程
pkill -f "vite"

# 方法4：停止esbuild进程
pkill -f "esbuild"
```

#### 停止后端服务
```bash
# 停止node server.js进程
ps aux | grep 'node server.js' | grep -v grep | awk '{print $2}' | xargs -r kill -9
```

#### 强制清理端口（如需要）
```bash
# 检查端口占用
sudo lsof -i :8889
sudo lsof -i :3002

# 强制停止占用端口的进程
sudo lsof -i :8889 | grep LISTEN | awk '{print $2}' | xargs -r kill -9
sudo lsof -i :3002 | grep LISTEN | awk '{print $2}' | xargs -r kill -9
```

### 5. 启动后端服务

#### 进入后端目录
```bash
cd /home/ec2-user/nanobanana/server
```

#### 创建日志目录（如不存在）
```bash
mkdir -p logs
```

#### 启动后端服务
```bash
nohup node server.js > logs/server-$(date +%Y-%m-%d).log 2>&1 &
```

#### 验证后端启动
```bash
# 检查进程
ps aux | grep 'node server.js' | grep -v grep

# 检查端口
sudo lsof -i :3002

# 健康检查
curl -I localhost:3002/health
```

### 6. 启动前端服务

#### 返回项目根目录
```bash
cd /home/ec2-user/nanobanana
```

#### 启动前端服务
```bash
nohup npx netlify dev --port 8889 > frontend-$(date +%Y-%m-%d).log 2>&1 &
```

#### 验证前端启动
```bash
# 检查进程
ps aux | grep netlify | grep -v grep

# 检查端口
sudo lsof -i :8889

# 健康检查
curl -I localhost:8889
```

### 7. 验证服务状态

#### 检查所有相关进程
```bash
ps aux | grep -E "(node|npm|netlify)" | grep -v grep
```

#### 检查端口监听
```bash
sudo netstat -tlnp | grep -E ":(8889|3002)"
```

#### 测试网站访问
```bash
# 测试前端
curl -I https://nanobanana.gitagent.io

# 测试后端API
curl -I https://nanobanana.gitagent.io/api/health
```

## 快速重启脚本

### 创建重启脚本
```bash
# 在服务器上创建重启脚本
cat > /home/ec2-user/restart-services.sh << 'EOF'
#!/bin/bash

echo "=== 停止所有服务 ==="
pkill -f "npm run dev"
pkill -f "netlify"
pkill -f "vite"
pkill -f "esbuild"
ps aux | grep 'node server.js' | grep -v grep | awk '{print $2}' | xargs -r kill -9

echo "等待进程完全停止..."
sleep 5

echo "=== 启动后端服务 ==="
cd /home/ec2-user/nanobanana/server
mkdir -p logs
nohup node server.js > logs/server-$(date +%Y-%m-%d).log 2>&1 &
echo "后端服务已启动"

echo "等待后端服务启动..."
sleep 10

echo "=== 启动前端服务 ==="
cd /home/ec2-user/nanobanana
nohup npx netlify dev --port 8889 > frontend-$(date +%Y-%m-%d).log 2>&1 &
echo "前端服务已启动"

echo "等待前端服务启动..."
sleep 15

echo "=== 检查服务状态 ==="
echo "后端端口检查:"
sudo lsof -i :3002

echo "前端端口检查:"
sudo lsof -i :8889

echo "=== 健康检查 ==="
echo "后端健康检查:"
curl -I localhost:3002/health

echo "前端健康检查:"
curl -I localhost:8889

echo "=== 重启完成 ==="
EOF

# 给脚本执行权限
chmod +x /home/ec2-user/restart-services.sh
```

### 使用重启脚本
```bash
# 执行重启脚本
/home/ec2-user/restart-services.sh
```

## 常见问题排查

### 1. 502 Bad Gateway
**原因**: 前端服务未在8889端口运行
```bash
# 检查前端服务
sudo lsof -i :8889
# 如果没有输出，重新启动前端服务
```

### 2. API请求失败
**原因**: 后端服务未在3002端口运行
```bash
# 检查后端服务
sudo lsof -i :3002
curl localhost:3002/health
# 如果失败，重新启动后端服务
```

### 3. 端口被占用
```bash
# 查看占用进程
sudo lsof -i :8889
sudo lsof -i :3002

# 强制停止
sudo lsof -i :8889 | grep LISTEN | awk '{print $2}' | xargs -r kill -9
sudo lsof -i :3002 | grep LISTEN | awk '{print $2}' | xargs -r kill -9
```

### 4. 权限问题
```bash
# 检查文件权限
ls -la /home/ec2-user/nanobanana/

# 修复权限（如需要）
sudo chown -R ec2-user:ec2-user /home/ec2-user/nanobanana/
```

### 5. 环境变量问题
```bash
# 检查.env文件
cat /home/ec2-user/nanobanana/.env
cat /home/ec2-user/nanobanana/server/.env

# 确保包含必要的配置
```

## 日志查看

### 查看后端日志
```bash
# 实时查看
tail -f /home/ec2-user/nanobanana/server/logs/server-$(date +%Y-%m-%d).log

# 查看最近100行
tail -100 /home/ec2-user/nanobanana/server/logs/server-$(date +%Y-%m-%d).log
```

### 查看前端日志
```bash
# 实时查看
tail -f /home/ec2-user/nanobanana/frontend-$(date +%Y-%m-%d).log

# 查看最近100行
tail -100 /home/ec2-user/nanobanana/frontend-$(date +%Y-%m-%d).log
```

### 查看Nginx日志
```bash
# 访问日志
sudo tail -f /var/log/nginx/access.log

# 错误日志
sudo tail -f /var/log/nginx/error.log
```

## 系统服务管理

### 检查Nginx状态
```bash
sudo systemctl status nginx
sudo systemctl restart nginx
sudo systemctl reload nginx
```

### 检查系统资源
```bash
# 内存使用
free -h

# 磁盘使用
df -h

# CPU使用
top
```

## 备注

1. **日志文件**: 按日期自动创建，便于问题排查
2. **后台运行**: 使用 `nohup` 确保SSH断开后服务继续运行
3. **端口固定**: 前端8889，后端3002，避免冲突
4. **健康检查**: 启动后务必验证服务状态
5. **权限管理**: 确保ec2-user有足够权限操作文件

## 联系信息

如遇问题，请检查：
1. 服务器日志文件
2. Nginx配置和状态
3. 端口占用情况
4. 系统资源使用情况

技术支持：support@nanobanana.gitagent.io
