# AicePS 快速部署指南

## 一键部署脚本

### 本地环境设置
```bash
# 1. 创建 conda 环境
conda create -n AicePS python=3.9 -y
conda activate AicePS

# 2. 安装 Node.js
conda install nodejs=20 -c conda-forge -y

# 3. 克隆项目
git clone https://github.com/hangeaiagent/aice_ps.git
cd aice_ps

# 4. 安装依赖
npm install

# 5. 配置 API 密钥
echo "GEMINI_API_KEY=你的API密钥" > .env

# 6. 启动应用
npm run dev -- --port 8889
```

### 服务器部署
```bash
# 连接服务器
ssh -i /Users/a1/work/productmindai.pem ec2-user@54.89.140.250

# 部署项目
cd /home/ec2-user/nanobanana
git pull origin main

# 设置环境
conda activate AicePS
npm install
cd server && npm install && cd ..

# 复制配置文件 (从本地)
scp -i /Users/a1/work/productmindai.pem .env ec2-user@54.89.140.250:/home/ec2-user/nanobanana/
scp -i /Users/a1/work/productmindai.pem server/.env ec2-user@54.89.140.250:/home/ec2-user/nanobanana/server/

# 停止旧服务
pkill -f 'npm.*dev' && pkill -f 'npm.*start' && pkill -f 'node.*server' || true

# 启动后台服务
cd server && nohup npm start > ../server.log 2>&1 &

# 启动前端服务
cd .. && nohup npm run dev -- --port 8889 --host 0.0.0.0 > frontend.log 2>&1 &
```

### 部署后检查清单
```bash
# 1. 检查服务状态
netstat -tlnp | grep -E ':(8889|3002)'

# 2. 检查应用健康
curl -s http://localhost:3002/health
curl -s -I http://localhost:8889

# 3. 检查Nginx配置
sudo nginx -t
grep -n "localhost:8889" /etc/nginx/sites-available/nanobanana.gitagent.io

# 4. 测试外部访问
curl -I https://nanobanana.gitagent.io

# 5. 如果403错误，检查vite.config.ts
grep -A 10 "allowedHosts" /home/ec2-user/nanobanana/vite.config.ts
```

## 访问地址

- **本地开发**: http://localhost:8889/
- **生产环境**: https://nanobanana.gitagent.io/
- **服务器直连**: http://54.89.140.250:8889/

## 常用命令

```bash
# 查看应用状态
ps aux | grep npm

# 重启应用
pkill -f npm && nohup npm run dev > app.log 2>&1 &

# 查看日志
tail -f app.log

# 测试访问
curl -I https://nanobanana.gitagent.io
```

## 故障排除

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 502 Bad Gateway | 应用未在8889端口运行 | 检查应用是否在8889端口运行：`netstat -tlnp \| grep 8889` |
| 502 Bad Gateway | Nginx代理端口错误 | 检查并更新Nginx配置端口：`sudo sed -i 's/localhost:8890/localhost:8889/g' /etc/nginx/sites-available/nanobanana.gitagent.io && sudo systemctl reload nginx` |
| 403 Forbidden | vite.config.ts缺少allowedHosts | 确保vite.config.ts包含完整server配置（见下方配置模板） |
| 406 Not Acceptable | Supabase RLS策略缺失 | 在Supabase Dashboard执行RLS策略修复脚本（见database/README_FIX_406_ERROR.md） |
| 价格页面无法访问 | 支付表RLS策略问题 | 执行`database/fix_rls_policies.sql`修复RLS策略 |
| 账户设置报错 | 用户积分记录不存在 | 为现有用户创建积分记录，启用自动初始化触发器 |
| 端口冲突 | 多个进程占用端口 | 使用固定端口8889，杀死占用进程：`pkill -f 'npm.*dev'` |
| SSL问题 | 证书过期或配置错误 | 检查证书有效期，重新运行certbot |

### 必需的vite.config.ts配置模板
```typescript
import path from 'path';
import { defineConfig, loadEnv } from 'vite';

export default defineConfig(({ mode }) => {
    const env = loadEnv(mode, '.', '');
    return {
      define: {
        'process.env.API_KEY': JSON.stringify(env.GEMINI_API_KEY),
        'process.env.GEMINI_API_KEY': JSON.stringify(env.GEMINI_API_KEY)
      },
      server: {
        host: '0.0.0.0',
        port: 8889,
        cors: true,
        allowedHosts: ['nanobanana.gitagent.io', 'localhost', '127.0.0.1'],
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type, Authorization'
        }
      },
      resolve: {
        alias: {
          '@': path.resolve(__dirname, '.'),
        }
      }
    };
});
```

---
**快速联系**: 遇到问题请查看完整部署文档
