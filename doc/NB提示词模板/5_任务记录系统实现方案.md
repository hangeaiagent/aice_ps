# ç”¨æˆ·ä»»åŠ¡è®°å½•ç³»ç»Ÿå®ç°æ–¹æ¡ˆ

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-09-18  
**æœ€åæ›´æ–°**: 2025-09-18  

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

ç”¨æˆ·ä»»åŠ¡è®°å½•ç³»ç»Ÿæ˜¯ä¸€ä¸ªå®Œæ•´çš„å›¾ç‰‡ç”Ÿæˆä»»åŠ¡ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œå®ç°äº†ç”¨æˆ·ç™»å½•åçš„å›¾ç‰‡ç”Ÿæˆè®°å½•ã€ç»Ÿè®¡åˆ†æã€äº‘å­˜å‚¨ç®¡ç†ç­‰åŠŸèƒ½ã€‚

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

1. **ä»»åŠ¡è®°å½•ç®¡ç†**
   - è‡ªåŠ¨è®°å½•ç”¨æˆ·çš„å›¾ç‰‡ç”Ÿæˆä»»åŠ¡
   - ä¿å­˜æç¤ºè¯ã€åŸå§‹å›¾ç‰‡ã€ç”Ÿæˆå›¾ç‰‡
   - è·Ÿè¸ªä»»åŠ¡çŠ¶æ€å’Œæ‰§è¡Œæ—¶é—´

2. **äº‘å­˜å‚¨é›†æˆ**
   - å›¾ç‰‡è‡ªåŠ¨ä¸Šä¼ åˆ°AWS S3
   - å®‰å…¨çš„è®¿é—®æ§åˆ¶å’Œæƒé™ç®¡ç†
   - é«˜å¯ç”¨æ€§å’ŒæŒä¹…åŒ–å­˜å‚¨

3. **ç»Ÿè®¡åˆ†æ**
   - Tokenæ¶ˆè€—ç»Ÿè®¡
   - ç§¯åˆ†æ‰£é™¤è®°å½•
   - æˆåŠŸç‡å’Œå¹³å‡è€—æ—¶åˆ†æ

4. **ç”¨æˆ·ç•Œé¢**
   - ç›´è§‚çš„ä»»åŠ¡å†å²æµè§ˆ
   - çµæ´»çš„ç­›é€‰å’Œåˆ†é¡µåŠŸèƒ½
   - å“åº”å¼è®¾è®¡å’Œè‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### ä¸»è¦æ•°æ®è¡¨

#### 1. user_task_history (ä»»åŠ¡è®°å½•ä¸»è¡¨)
```sql
CREATE TABLE user_task_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    task_type VARCHAR(50) NOT NULL DEFAULT 'image_generation',
    prompt TEXT NOT NULL,
    original_image_url TEXT,
    generated_image_url TEXT,
    aws_original_key TEXT,
    aws_generated_key TEXT,
    tokens_used INTEGER DEFAULT 0,
    credits_deducted INTEGER DEFAULT 0,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    error_message TEXT,
    aspect_ratio VARCHAR(10),
    model_version VARCHAR(50),
    generation_time_ms INTEGER,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    completed_at TIMESTAMP WITH TIME ZONE
);
```

**å­—æ®µè¯´æ˜**ï¼š
- `task_type`: ä»»åŠ¡ç±»å‹ (image_generation, image_edit, template_generation)
- `prompt`: ç”¨æˆ·è¾“å…¥çš„æç¤ºè¯
- `original_image_url`: åŸå§‹å›¾ç‰‡çš„å…¬å¼€è®¿é—®URL
- `generated_image_url`: ç”Ÿæˆå›¾ç‰‡çš„å…¬å¼€è®¿é—®URL
- `aws_original_key`: AWS S3ä¸­åŸå§‹å›¾ç‰‡çš„å­˜å‚¨key
- `aws_generated_key`: AWS S3ä¸­ç”Ÿæˆå›¾ç‰‡çš„å­˜å‚¨key
- `tokens_used`: æœ¬æ¬¡ä»»åŠ¡æ¶ˆè€—çš„tokenæ•°é‡
- `credits_deducted`: æœ¬æ¬¡ä»»åŠ¡æ‰£é™¤çš„ç§¯åˆ†ç‚¹æ•°
- `status`: ä»»åŠ¡çŠ¶æ€ (pending, processing, completed, failed)

#### 2. user_task_statistics (ç»Ÿè®¡æ±‡æ€»è¡¨)
```sql
CREATE TABLE user_task_statistics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    period_type VARCHAR(20) NOT NULL,
    period_date DATE NOT NULL,
    total_tasks INTEGER DEFAULT 0,
    successful_tasks INTEGER DEFAULT 0,
    failed_tasks INTEGER DEFAULT 0,
    total_tokens_used INTEGER DEFAULT 0,
    total_credits_deducted INTEGER DEFAULT 0,
    total_generation_time_ms BIGINT DEFAULT 0,
    avg_generation_time_ms INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(user_id, period_type, period_date)
);
```

### å®‰å…¨ç­–ç•¥

- **RLS (Row Level Security)**: ç¡®ä¿ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
- **è®¤è¯æ£€æŸ¥**: æ‰€æœ‰APIéƒ½éœ€è¦æœ‰æ•ˆçš„JWT token
- **æƒé™éªŒè¯**: åŸºäºç”¨æˆ·è®¢é˜…è®¡åˆ’çš„åŠŸèƒ½è®¿é—®æ§åˆ¶

## ğŸ”§ åç«¯APIè®¾è®¡

### APIè·¯ç”±ç»“æ„
```
/api/task-history/
â”œâ”€â”€ POST   /tasks                    # åˆ›å»ºä»»åŠ¡è®°å½•
â”œâ”€â”€ PUT    /tasks/:id/original-image # ä¸Šä¼ åŸå§‹å›¾ç‰‡
â”œâ”€â”€ PUT    /tasks/:id/complete       # å®Œæˆä»»åŠ¡è®°å½•
â”œâ”€â”€ GET    /tasks                    # è·å–ä»»åŠ¡åˆ—è¡¨
â”œâ”€â”€ GET    /tasks/:id               # è·å–ä»»åŠ¡è¯¦æƒ…
â”œâ”€â”€ DELETE /tasks/:id               # åˆ é™¤ä»»åŠ¡è®°å½•
â””â”€â”€ GET    /statistics              # è·å–ç»Ÿè®¡ä¿¡æ¯
```

### æ ¸å¿ƒAPIåŠŸèƒ½

#### 1. åˆ›å»ºä»»åŠ¡è®°å½•
```javascript
POST /api/task-history/tasks
{
  "task_type": "image_generation",
  "prompt": "ç”¨æˆ·è¾“å…¥çš„æç¤ºè¯",
  "aspect_ratio": "1:1",
  "model_version": "gemini-1.5-pro"
}
```

#### 2. å®Œæˆä»»åŠ¡è®°å½•
```javascript
PUT /api/task-history/tasks/:taskId/complete
{
  "generated_image_data": "data:image/jpeg;base64,...",
  "tokens_used": 150,
  "credits_deducted": 1,
  "generation_time_ms": 5000
}
```

#### 3. è·å–ä»»åŠ¡åˆ—è¡¨
```javascript
GET /api/task-history/tasks?page=1&limit=50&start_date=2025-09-01&end_date=2025-09-18&status=completed
```

### AWS S3é›†æˆ

#### å­˜å‚¨ç»“æ„
```
S3å­˜å‚¨æ¡¶: spotgitagent
â”œâ”€â”€ task-history/
â”‚   â””â”€â”€ {user_id}/
â”‚       â””â”€â”€ {task_id}/
â”‚           â”œâ”€â”€ original.{ext}    # åŸå§‹å›¾ç‰‡
â”‚           â””â”€â”€ generated.jpg     # ç”Ÿæˆå›¾ç‰‡
```

#### å®‰å…¨é…ç½®
- **è®¿é—®æ§åˆ¶**: å…¬å¼€è¯»å–ï¼ŒæœåŠ¡ç«¯å†™å…¥
- **CORSé…ç½®**: å…è®¸å‰ç«¯åŸŸåè®¿é—®
- **ç”Ÿå‘½å‘¨æœŸç®¡ç†**: å¯é…ç½®è‡ªåŠ¨æ¸…ç†ç­–ç•¥

## ğŸ¨ å‰ç«¯å®ç°

### ç»„ä»¶æ¶æ„

#### 1. TaskHistoryPage (ä»»åŠ¡è®°å½•é¡µé¢)
**åŠŸèƒ½ç‰¹æ€§**ï¼š
- ä»»åŠ¡åˆ—è¡¨å±•ç¤ºå’Œåˆ†é¡µ
- æ—¶é—´èŒƒå›´ç­›é€‰
- çŠ¶æ€å’Œç±»å‹è¿‡æ»¤
- ç»Ÿè®¡ä¿¡æ¯å±•ç¤º
- å›¾ç‰‡é¢„è§ˆå’Œç¯ç®±

**ä¸»è¦çŠ¶æ€**ï¼š
```typescript
interface TaskHistoryState {
  tasks: TaskRecord[];
  statistics: TaskStatistics;
  currentPage: number;
  totalPages: number;
  startDate: string;
  endDate: string;
  statusFilter: string;
  taskTypeFilter: string;
}
```

#### 2. TaskHistoryService (ä»»åŠ¡è®°å½•æœåŠ¡)
**æ ¸å¿ƒæ–¹æ³•**ï¼š
```typescript
class TaskHistoryService {
  async createTask(taskData): Promise<TaskRecord>
  async uploadOriginalImage(taskId, imageFile): Promise<TaskRecord>
  async completeTask(taskId, completionData): Promise<TaskRecord>
  async getTasks(params): Promise<PaginatedTaskResult>
  async getStatistics(period): Promise<TaskStatistics>
  async recordImageGeneration(prompt, taskType, aspectRatio, originalImageFile)
}
```

#### 3. HybridImageServiceé›†æˆ
**ä»»åŠ¡è®°å½•æµç¨‹**ï¼š
```typescript
async generateImageFromText(prompt: string, aspectRatio: string) {
  // 1. æƒé™æ£€æŸ¥å’Œç§¯åˆ†æ¶ˆè´¹
  const permissionCheck = await this.checkPermissionAndConsumeCredits();
  
  // 2. åˆ›å»ºä»»åŠ¡è®°å½•
  const taskRecord = await taskHistoryService.recordImageGeneration();
  
  // 3. æ‰§è¡Œå›¾ç‰‡ç”Ÿæˆ
  const imageDataUrl = await this.performGeneration();
  
  // 4. å®Œæˆä»»åŠ¡è®°å½•
  await taskRecord.completeTask({
    imageDataUrl,
    tokensUsed,
    creditsDeducted,
    generationTimeMs
  });
}
```

### ç”¨æˆ·ç•Œé¢è®¾è®¡

#### 1. ä»»åŠ¡è®°å½•å…¥å£
- **ä½ç½®**: ç”¨æˆ·èœå• -> ä»»åŠ¡è®°å½•
- **å›¾æ ‡**: æ–‡æ¡£å›¾æ ‡
- **æƒé™**: ä»…ç™»å½•ç”¨æˆ·å¯è§

#### 2. ä»»åŠ¡åˆ—è¡¨ç•Œé¢
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»»åŠ¡è®°å½•                                    [è¿”å›]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“Š ç»Ÿè®¡ä¿¡æ¯                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚æ€»ä»»åŠ¡æ•° â”‚ â”‚ æˆåŠŸç‡  â”‚ â”‚æ¶ˆè€—ç§¯åˆ†â”‚ â”‚å¹³å‡è€—æ—¶â”‚   â”‚
â”‚ â”‚   156   â”‚ â”‚  94.2%  â”‚ â”‚  156   â”‚ â”‚  3.2s  â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ” ç­›é€‰å™¨                                          â”‚
â”‚ [å¼€å§‹æ—¥æœŸ] [ç»“æŸæ—¥æœŸ] [çŠ¶æ€] [ä»»åŠ¡ç±»å‹]           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“‹ ä»»åŠ¡åˆ—è¡¨                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ âœ… å›¾ç‰‡ç”Ÿæˆ | 2025-09-18 14:30                â”‚ â”‚
â”‚ â”‚ æç¤ºè¯: "ä¸€åªæˆ´ç€å®‡èˆªå‘˜å¤´ç›”çš„å°ç‹—..."          â”‚ â”‚
â”‚ â”‚ [åŸå›¾] [ç”Ÿæˆå›¾] | 150 tokens | 1 ç§¯åˆ† | 3.2s  â”‚ â”‚
â”‚ â”‚                                    [æŸ¥çœ‹][åˆ é™¤] â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ âŒ å›¾ç‰‡ç¼–è¾‘ | 2025-09-18 13:45                â”‚ â”‚
â”‚ â”‚ æç¤ºè¯: "å°†èƒŒæ™¯æ”¹ä¸ºå¤•é˜³è¥¿ä¸‹çš„æµ·æ»©"             â”‚ â”‚
â”‚ â”‚ [åŸå›¾] [--] | 120 tokens | 1 ç§¯åˆ† | å¤±è´¥      â”‚ â”‚
â”‚ â”‚ é”™è¯¯: å›¾ç‰‡å¤„ç†è¶…æ—¶                             â”‚ â”‚
â”‚ â”‚                                    [æŸ¥çœ‹][åˆ é™¤] â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              [ä¸Šä¸€é¡µ] 1/10 [ä¸‹ä¸€é¡µ] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ ç³»ç»Ÿé›†æˆæµç¨‹

### å›¾ç‰‡ç”Ÿæˆä»»åŠ¡æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å‰ç«¯
    participant H as HybridImageService
    participant T as TaskHistoryService
    participant B as åç«¯API
    participant S as AWS S3
    participant D as æ•°æ®åº“

    U->>F: è¾“å…¥æç¤ºè¯ï¼Œç‚¹å‡»ç”Ÿæˆ
    F->>H: generateImageFromText()
    H->>H: æƒé™æ£€æŸ¥å’Œç§¯åˆ†æ¶ˆè´¹
    H->>T: recordImageGeneration()
    T->>B: POST /api/task-history/tasks
    B->>D: åˆ›å»ºä»»åŠ¡è®°å½•
    D-->>B: è¿”å›ä»»åŠ¡ID
    B-->>T: è¿”å›ä»»åŠ¡è®°å½•
    
    H->>H: æ‰§è¡Œå›¾ç‰‡ç”Ÿæˆ
    H->>T: completeTask()
    T->>B: PUT /api/task-history/tasks/:id/complete
    B->>S: ä¸Šä¼ ç”Ÿæˆå›¾ç‰‡
    S-->>B: è¿”å›å›¾ç‰‡URL
    B->>D: æ›´æ–°ä»»åŠ¡è®°å½•
    D-->>B: æ›´æ–°æˆåŠŸ
    B-->>T: è¿”å›å®Œæˆçš„ä»»åŠ¡
    T-->>H: ä»»åŠ¡è®°å½•å®Œæˆ
    H-->>F: è¿”å›ç”Ÿæˆçš„å›¾ç‰‡
    F-->>U: æ˜¾ç¤ºç”Ÿæˆç»“æœ
```

### ä»»åŠ¡æŸ¥è¯¢æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as TaskHistoryPage
    participant T as TaskHistoryService
    participant B as åç«¯API
    participant D as æ•°æ®åº“

    U->>F: è®¿é—®ä»»åŠ¡è®°å½•é¡µé¢
    F->>T: getTasks()
    T->>B: GET /api/task-history/tasks
    B->>D: æŸ¥è¯¢ç”¨æˆ·ä»»åŠ¡è®°å½•
    D-->>B: è¿”å›ä»»åŠ¡åˆ—è¡¨
    B-->>T: è¿”å›åˆ†é¡µç»“æœ
    T-->>F: è¿”å›ä»»åŠ¡æ•°æ®
    F-->>U: æ˜¾ç¤ºä»»åŠ¡åˆ—è¡¨

    U->>F: è®¾ç½®ç­›é€‰æ¡ä»¶
    F->>T: getTasks(filters)
    T->>B: GET /api/task-history/tasks?filters
    B->>D: æŒ‰æ¡ä»¶æŸ¥è¯¢
    D-->>B: è¿”å›ç­›é€‰ç»“æœ
    B-->>T: è¿”å›ç­›é€‰æ•°æ®
    T-->>F: æ›´æ–°ä»»åŠ¡åˆ—è¡¨
    F-->>U: æ˜¾ç¤ºç­›é€‰ç»“æœ
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ä¼˜åŒ–
1. **ç´¢å¼•ç­–ç•¥**
   ```sql
   CREATE INDEX idx_user_task_history_user_created ON user_task_history(user_id, created_at DESC);
   CREATE INDEX idx_user_task_history_status ON user_task_history(status);
   ```

2. **åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–**
   - ä½¿ç”¨LIMITå’ŒOFFSETè¿›è¡Œåˆ†é¡µ
   - æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡

3. **ç»Ÿè®¡æ•°æ®é¢„è®¡ç®—**
   - ä½¿ç”¨è§¦å‘å™¨è‡ªåŠ¨æ›´æ–°ç»Ÿè®¡è¡¨
   - å‡å°‘å®æ—¶è®¡ç®—çš„æ€§èƒ½å¼€é”€

### å‰ç«¯ä¼˜åŒ–
1. **å›¾ç‰‡æ‡’åŠ è½½**
   - ä»»åŠ¡åˆ—è¡¨ä¸­çš„å›¾ç‰‡é¢„è§ˆä½¿ç”¨æ‡’åŠ è½½
   - å‡å°‘åˆå§‹é¡µé¢åŠ è½½æ—¶é—´

2. **è™šæ‹Ÿæ»šåŠ¨**
   - å¤§é‡ä»»åŠ¡è®°å½•æ—¶ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨
   - æé«˜åˆ—è¡¨æ¸²æŸ“æ€§èƒ½

3. **ç¼“å­˜ç­–ç•¥**
   - ç»Ÿè®¡æ•°æ®æœ¬åœ°ç¼“å­˜
   - å‡å°‘é‡å¤APIè¯·æ±‚

### AWS S3ä¼˜åŒ–
1. **CDNåŠ é€Ÿ**
   - é…ç½®CloudFront CDN
   - æé«˜å›¾ç‰‡è®¿é—®é€Ÿåº¦

2. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**
   - è®¾ç½®è‡ªåŠ¨æ¸…ç†ç­–ç•¥
   - æ§åˆ¶å­˜å‚¨æˆæœ¬

## ğŸ”’ å®‰å…¨è€ƒè™‘

### æ•°æ®å®‰å…¨
1. **è¡Œçº§å®‰å…¨ (RLS)**
   ```sql
   CREATE POLICY "Users can view own task history" ON user_task_history
       FOR SELECT USING (auth.uid() = user_id);
   ```

2. **APIè®¤è¯**
   - æ‰€æœ‰APIéƒ½éœ€è¦æœ‰æ•ˆçš„JWT token
   - éªŒè¯ç”¨æˆ·èº«ä»½å’Œæƒé™

3. **æ•°æ®åŠ å¯†**
   - æ•æ„Ÿæ•°æ®ä¼ è¾“ä½¿ç”¨HTTPS
   - æ•°æ®åº“è¿æ¥ä½¿ç”¨SSL

### æ–‡ä»¶å®‰å…¨
1. **ä¸Šä¼ éªŒè¯**
   - æ–‡ä»¶ç±»å‹å’Œå¤§å°é™åˆ¶
   - æ¶æ„æ–‡ä»¶æ£€æµ‹

2. **è®¿é—®æ§åˆ¶**
   - S3å­˜å‚¨æ¡¶æƒé™é…ç½®
   - é˜²æ­¢æœªæˆæƒè®¿é—®

## ğŸ“ˆ ç›‘æ§å’Œç»´æŠ¤

### ç³»ç»Ÿç›‘æ§
1. **æ€§èƒ½æŒ‡æ ‡**
   - APIå“åº”æ—¶é—´
   - æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
   - å›¾ç‰‡ä¸Šä¼ æˆåŠŸç‡

2. **é”™è¯¯ç›‘æ§**
   - ä»»åŠ¡å¤±è´¥ç‡ç»Ÿè®¡
   - é”™è¯¯æ—¥å¿—æ”¶é›†å’Œåˆ†æ

3. **èµ„æºä½¿ç”¨**
   - æ•°æ®åº“å­˜å‚¨ä½¿ç”¨é‡
   - S3å­˜å‚¨æˆæœ¬ç›‘æ§

### ç»´æŠ¤ä»»åŠ¡
1. **æ•°æ®æ¸…ç†**
   - å®šæœŸæ¸…ç†è¿‡æœŸä»»åŠ¡è®°å½•
   - åˆ é™¤æ— æ•ˆçš„å›¾ç‰‡æ–‡ä»¶

2. **æ€§èƒ½è°ƒä¼˜**
   - å®šæœŸåˆ†ææ…¢æŸ¥è¯¢
   - ä¼˜åŒ–æ•°æ®åº“ç´¢å¼•

3. **å¤‡ä»½ç­–ç•¥**
   - å®šæœŸå¤‡ä»½ä»»åŠ¡æ•°æ®
   - ç¾éš¾æ¢å¤è®¡åˆ’

## ğŸš€ éƒ¨ç½²æŒ‡å—

### ç¯å¢ƒè¦æ±‚
- Node.js 18+
- PostgreSQL (Supabase)
- AWS S3å­˜å‚¨æ¡¶
- Nginxåå‘ä»£ç†

### éƒ¨ç½²æ­¥éª¤

1. **æ•°æ®åº“è¿ç§»**
   ```bash
   # åœ¨Supabaseæ§åˆ¶å°æ‰§è¡Œ
   psql -f database/create_task_history_tables.sql
   ```

2. **ç¯å¢ƒå˜é‡é…ç½®**
   ```bash
   # .envæ–‡ä»¶
   AWS_ACCESS_KEY_ID=your_access_key
   AWS_SECRET_ACCESS_KEY=your_secret_key
   AWS_REGION=us-east-1
   S3_BUCKET_NAME=spotgitagent
   SUPABASE_URL=your_supabase_url
   SUPABASE_SERVICE_ROLE_KEY=your_service_key
   ```

3. **æœåŠ¡éƒ¨ç½²**
   ```bash
   # ä½¿ç”¨éƒ¨ç½²è„šæœ¬
   ./deploy_task_history_system.sh
   ```

4. **éªŒè¯éƒ¨ç½²**
   - æ£€æŸ¥APIå¥åº·çŠ¶æ€
   - æµ‹è¯•ç”¨æˆ·ç™»å½•å’Œä»»åŠ¡è®°å½•åŠŸèƒ½
   - éªŒè¯å›¾ç‰‡ä¸Šä¼ å’Œæ˜¾ç¤º

## ğŸ“ ä½¿ç”¨è¯´æ˜

### ç”¨æˆ·æ“ä½œæµç¨‹

1. **è®¿é—®ä»»åŠ¡è®°å½•**
   - ç™»å½•ç³»ç»Ÿ
   - ç‚¹å‡»ç”¨æˆ·èœå• -> ä»»åŠ¡è®°å½•

2. **æŸ¥çœ‹ä»»åŠ¡å†å²**
   - æµè§ˆä»»åŠ¡åˆ—è¡¨
   - ä½¿ç”¨ç­›é€‰å™¨æŸ¥æ‰¾ç‰¹å®šä»»åŠ¡
   - æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…å’Œç»Ÿè®¡ä¿¡æ¯

3. **ç®¡ç†ä»»åŠ¡è®°å½•**
   - æŸ¥çœ‹åŸå§‹å›¾ç‰‡å’Œç”Ÿæˆå›¾ç‰‡
   - åˆ é™¤ä¸éœ€è¦çš„ä»»åŠ¡è®°å½•
   - å¯¼å‡ºä»»åŠ¡æ•°æ®ï¼ˆæœªæ¥åŠŸèƒ½ï¼‰

### ç®¡ç†å‘˜åŠŸèƒ½

1. **ç³»ç»Ÿç›‘æ§**
   - æŸ¥çœ‹æ•´ä½“ä½¿ç”¨ç»Ÿè®¡
   - ç›‘æ§ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡
   - åˆ†æç”¨æˆ·è¡Œä¸ºæ•°æ®

2. **æ•°æ®ç®¡ç†**
   - æ‰¹é‡æ¸…ç†è¿‡æœŸæ•°æ®
   - ç®¡ç†å­˜å‚¨é…é¢
   - å¤‡ä»½é‡è¦æ•°æ®

## ğŸ”® æœªæ¥æ‰©å±•

### è®¡åˆ’åŠŸèƒ½
1. **é«˜çº§ç»Ÿè®¡**
   - æ›´è¯¦ç»†çš„ä½¿ç”¨åˆ†æ
   - æˆæœ¬åˆ†æå’Œé¢„æµ‹
   - ç”¨æˆ·è¡Œä¸ºæ´å¯Ÿ

2. **æ•°æ®å¯¼å‡º**
   - æ”¯æŒCSV/JSONæ ¼å¼å¯¼å‡º
   - æ‰¹é‡ä¸‹è½½å›¾ç‰‡
   - ä»»åŠ¡æŠ¥å‘Šç”Ÿæˆ

3. **åä½œåŠŸèƒ½**
   - ä»»åŠ¡åˆ†äº«å’Œåä½œ
   - å›¢é˜Ÿç»Ÿè®¡å’Œç®¡ç†
   - æƒé™ç»†åŒ–æ§åˆ¶

4. **AIå¢å¼º**
   - æ™ºèƒ½ä»»åŠ¡æ¨è
   - è‡ªåŠ¨æ ‡ç­¾å’Œåˆ†ç±»
   - è´¨é‡è¯„ä¼°å’Œä¼˜åŒ–å»ºè®®

---

**æ–‡æ¡£ç»´æŠ¤**: äº§å“å¼€å‘å›¢é˜Ÿ  
**æŠ€æœ¯è´Ÿè´£**: AI Assistant  
**æ›´æ–°é¢‘ç‡**: æ ¹æ®åŠŸèƒ½è¿­ä»£å®æ—¶æ›´æ–°
