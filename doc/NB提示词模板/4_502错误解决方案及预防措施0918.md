# NanoBanana 502é”™è¯¯è§£å†³æ–¹æ¡ˆåŠé¢„é˜²æªæ–½

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-09-18  
**é—®é¢˜è§£å†³æ—¶é—´**: 2025-09-18 09:46 UTC  

## ğŸš¨ é—®é¢˜æ¦‚è¿°

### é”™è¯¯ç°è±¡
```
GET https://nanobanana.gitagent.io/api/user-permissions/e1b114bd-fe81-4822-b1f2-de28abded7d9 502 (Bad Gateway)
GET https://nanobanana.gitagent.io/api/templates?sort=popular&limit=6 502 (Bad Gateway)
```

### å½±å“èŒƒå›´
- NanoBananaç½‘ç«™æ‰€æœ‰APIè¯·æ±‚å¤±è´¥
- ç”¨æˆ·æƒé™è·å–å¤±è´¥
- æ¨¡æ¿æ•°æ®åŠ è½½å¤±è´¥
- ç½‘ç«™åŠŸèƒ½å®Œå…¨ä¸å¯ç”¨

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 
**Nginxé…ç½®é”™è¯¯** - APIä»£ç†æŒ‡å‘äº†é”™è¯¯çš„åç«¯ç«¯å£

### è¯¦ç»†åˆ†æ

1. **Nginxé”™è¯¯æ—¥å¿—æ˜¾ç¤º**ï¼š
   ```
   connect() failed (111: Connection refused) while connecting to upstream, 
   upstream: "http://127.0.0.1:3001/api/..."
   ```

2. **å®é™…æœåŠ¡ç«¯å£**ï¼š
   - NanoBananaåç«¯å®é™…è¿è¡Œåœ¨ç«¯å£ **3002**
   - Nginxé…ç½®å´æŒ‡å‘ç«¯å£ **3001**

3. **é…ç½®æ–‡ä»¶ä½ç½®**ï¼š
   `/etc/nginx/sites-available/nanobanana.gitagent.io`

4. **é”™è¯¯é…ç½®**ï¼š
   ```nginx
   location /api/ {
       proxy_pass http://localhost:3001/api/;  # âŒ é”™è¯¯ç«¯å£
       # ... å…¶ä»–é…ç½®
   }
   ```

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. ç«‹å³ä¿®å¤æ­¥éª¤

```bash
# 1. ä¿®å¤nginxé…ç½®ä¸­çš„ç«¯å£
sudo sed -i 's/localhost:3001/localhost:3002/g' /etc/nginx/sites-available/nanobanana.gitagent.io

# 2. æµ‹è¯•nginxé…ç½®
sudo nginx -t

# 3. é‡æ–°åŠ è½½nginx
sudo systemctl reload nginx

# 4. éªŒè¯ä¿®å¤
curl -s -o /dev/null -w '%{http_code}' https://nanobanana.gitagent.io/api/templates
# åº”è¯¥è¿”å› 200
```

### 2. æ­£ç¡®çš„Nginxé…ç½®

```nginx
server {
    server_name nanobanana.gitagent.io;
    
    # API ä»£ç†åˆ°åç«¯æœåŠ¡ (ç«¯å£3002) âœ… æ­£ç¡®ç«¯å£
    location /api/ {
        proxy_pass http://localhost:3002/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
        
        # CORS å¤´éƒ¨è®¾ç½®
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;
    }
    
    # å‰ç«¯åº”ç”¨ä»£ç† (ç«¯å£8889) âœ… æ­£ç¡®ç«¯å£
    location / {
        proxy_pass http://localhost:8889;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }
    
    # SSLé…ç½®ç”±Certbotç®¡ç†
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/nanobanana.gitagent.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/nanobanana.gitagent.io/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}
```

## ğŸ›¡ï¸ é¢„é˜²æªæ–½

### 1. è‡ªåŠ¨ç›‘æ§è„šæœ¬

åˆ›å»ºäº† `/home/ec2-user/nanobanana/service_monitor.sh` è„šæœ¬ï¼ŒåŠŸèƒ½åŒ…æ‹¬ï¼š

- **ç«¯å£æ£€æŸ¥**: éªŒè¯æ‰€æœ‰æœåŠ¡ç«¯å£æ˜¯å¦æ­£å¸¸è¿è¡Œ
- **URLæµ‹è¯•**: æ£€æŸ¥ç½‘ç«™å’ŒAPIæ˜¯å¦å¯è®¿é—®
- **è‡ªåŠ¨ä¿®å¤**: æ£€æµ‹åˆ°é—®é¢˜æ—¶è‡ªåŠ¨é‡å¯æœåŠ¡
- **è¯¦ç»†æ—¥å¿—**: è®°å½•æ‰€æœ‰ç›‘æ§æ´»åŠ¨å’Œé—®é¢˜

### 2. å®šæ—¶ç›‘æ§ä»»åŠ¡

è®¾ç½®äº†crontabå®šæ—¶ä»»åŠ¡ï¼š
```bash
# æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æœåŠ¡çŠ¶æ€
*/5 * * * * /home/ec2-user/nanobanana/service_monitor.sh >> /home/ec2-user/nanobanana/monitor.log 2>&1
```

### 3. æœåŠ¡ç«¯å£æ ‡å‡†åŒ–

| æœåŠ¡ | ç«¯å£ | è¯´æ˜ |
|------|------|------|
| NanoBanana Backend | 3002 | Node.js APIæœåŠ¡ |
| NanoBanana Frontend | 8889 | Viteå¼€å‘æœåŠ¡å™¨ |
| Admin Backend | 8000 | Python FastAPIæœåŠ¡ |
| Admin Frontend | 9527 | é™æ€æ–‡ä»¶æœåŠ¡ |

### 4. é…ç½®æ–‡ä»¶æ£€æŸ¥æ¸…å•

åœ¨ä¿®æ”¹é…ç½®åï¼Œå¿…é¡»æ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š

```bash
# 1. æ£€æŸ¥nginxé…ç½®è¯­æ³•
sudo nginx -t

# 2. æ£€æŸ¥ç«¯å£é…ç½®æ˜¯å¦æ­£ç¡®
grep -n "proxy_pass.*localhost:" /etc/nginx/sites-available/nanobanana.gitagent.io

# 3. éªŒè¯æœåŠ¡ç«¯å£
lsof -i :3002 -i :8889

# 4. æµ‹è¯•APIè®¿é—®
curl -I https://nanobanana.gitagent.io/api/templates

# 5. æ£€æŸ¥nginxé”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log
```

## ğŸ“Š ç›‘æ§å’Œè¯Šæ–­

### 1. å®æ—¶ç›‘æ§å‘½ä»¤

```bash
# æ£€æŸ¥æ‰€æœ‰æœåŠ¡çŠ¶æ€
/home/ec2-user/nanobanana/startnanobananaandadmin.sh status

# è¿è¡Œç›‘æ§è„šæœ¬
/home/ec2-user/nanobanana/service_monitor.sh

# æŸ¥çœ‹ç›‘æ§æ—¥å¿—
tail -f /home/ec2-user/nanobanana/monitor.log
```

### 2. é—®é¢˜è¯Šæ–­æ­¥éª¤

å½“å‡ºç°502é”™è¯¯æ—¶ï¼š

1. **æ£€æŸ¥nginxé”™è¯¯æ—¥å¿—**ï¼š
   ```bash
   sudo tail -20 /var/log/nginx/error.log
   ```

2. **æ£€æŸ¥æœåŠ¡ç«¯å£**ï¼š
   ```bash
   lsof -i :3002 -i :8889 -i :8000 -i :9527
   ```

3. **æ£€æŸ¥nginxé…ç½®**ï¼š
   ```bash
   grep "proxy_pass" /etc/nginx/sites-available/nanobanana.gitagent.io
   ```

4. **æµ‹è¯•åç«¯æœåŠ¡**ï¼š
   ```bash
   curl http://localhost:3002/api/templates
   ```

### 3. æ—¥å¿—æ–‡ä»¶ä½ç½®

- **Nginxé”™è¯¯æ—¥å¿—**: `/var/log/nginx/error.log`
- **Nginxè®¿é—®æ—¥å¿—**: `/var/log/nginx/access.log`
- **ç›‘æ§è„šæœ¬æ—¥å¿—**: `/home/ec2-user/nanobanana/monitor.log`
- **NanoBananaåç«¯æ—¥å¿—**: `/home/ec2-user/nanobanana/nanobanana.log`
- **NanoBananaå‰ç«¯æ—¥å¿—**: `/home/ec2-user/nanobanana/frontend.log`

## ğŸ”§ æ•…éšœæ¢å¤æµç¨‹

### è‡ªåŠ¨æ¢å¤
ç›‘æ§è„šæœ¬æ¯5åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥ï¼Œå‘ç°é—®é¢˜æ—¶ä¼šï¼š
1. è®°å½•é—®é¢˜è¯¦æƒ…
2. å°è¯•æ¸…ç†å†²çªç«¯å£
3. é‡å¯ç›¸å…³æœåŠ¡
4. éªŒè¯ä¿®å¤ç»“æœ

### æ‰‹åŠ¨æ¢å¤
å¦‚æœè‡ªåŠ¨æ¢å¤å¤±è´¥ï¼š

```bash
# 1. åœæ­¢æ‰€æœ‰æœåŠ¡
/home/ec2-user/nanobanana/startnanobananaandadmin.sh stop

# 2. æ¸…ç†ç«¯å£
pkill -f "node.*server"
pkill -f "npm.*dev"

# 3. æ£€æŸ¥nginxé…ç½®
sudo nginx -t

# 4. é‡å¯æœåŠ¡
/home/ec2-user/nanobanana/startnanobananaandadmin.sh start

# 5. éªŒè¯æ¢å¤
curl -I https://nanobanana.gitagent.io/api/templates
```

## ğŸ“‹ éªŒæ”¶æ ‡å‡†

ä¿®å¤å®Œæˆåï¼Œä»¥ä¸‹æ£€æŸ¥é¡¹å¿…é¡»å…¨éƒ¨é€šè¿‡ï¼š

- [ ] `curl https://nanobanana.gitagent.io/api/templates` è¿”å›200
- [ ] `curl https://nanobanana.gitagent.io/api/user-permissions/test` è¿”å›200æˆ–404ï¼ˆä¸æ˜¯502ï¼‰
- [ ] ç½‘ç«™é¦–é¡µå¯ä»¥æ­£å¸¸åŠ è½½
- [ ] æµè§ˆå™¨æ§åˆ¶å°æ— 502é”™è¯¯
- [ ] Nginxé”™è¯¯æ—¥å¿—æ— "Connection refused"é”™è¯¯
- [ ] ç›‘æ§è„šæœ¬è¿è¡Œæ­£å¸¸
- [ ] Crontabå®šæ—¶ä»»åŠ¡å·²è®¾ç½®

## ğŸ¯ ç»éªŒæ€»ç»“

### é—®é¢˜æ ¹æº
1. **é…ç½®ä¸ä¸€è‡´**: Nginxé…ç½®ä¸å®é™…æœåŠ¡ç«¯å£ä¸åŒ¹é…
2. **ç¼ºä¹ç›‘æ§**: æ²¡æœ‰åŠæ—¶å‘ç°é…ç½®é”™è¯¯
3. **æ–‡æ¡£ä¸å®Œæ•´**: ç«¯å£é…ç½®æ ‡å‡†æœªæ˜ç¡®è®°å½•

### æ”¹è¿›æªæ–½
1. **æ ‡å‡†åŒ–é…ç½®**: æ˜ç¡®å®šä¹‰æ‰€æœ‰æœåŠ¡ç«¯å£
2. **è‡ªåŠ¨ç›‘æ§**: å®šæ—¶æ£€æŸ¥æœåŠ¡çŠ¶æ€å’Œé…ç½®ä¸€è‡´æ€§
3. **é…ç½®éªŒè¯**: æ¯æ¬¡ä¿®æ”¹åå¿…é¡»éªŒè¯
4. **æ–‡æ¡£å®Œå–„**: è¯¦ç»†è®°å½•æ‰€æœ‰é…ç½®å’Œæµç¨‹

### é¢„é˜²å»ºè®®
1. **é…ç½®å˜æ›´**: ä»»ä½•nginxé…ç½®ä¿®æ”¹éƒ½å¿…é¡»æµ‹è¯•
2. **ç«¯å£ç®¡ç†**: ä¸¥æ ¼æŒ‰ç…§æ ‡å‡†åˆ†é…ç«¯å£
3. **ç›‘æ§å‘Šè­¦**: è®¾ç½®æ›´é¢‘ç¹çš„å¥åº·æ£€æŸ¥
4. **å¤‡ä»½æ¢å¤**: å®šæœŸå¤‡ä»½å…³é”®é…ç½®æ–‡ä»¶

---

**æ³¨æ„**: æ­¤é—®é¢˜çš„æ ¸å¿ƒæ˜¯é…ç½®ç®¡ç†ï¼Œé€šè¿‡æ ‡å‡†åŒ–é…ç½®å’Œè‡ªåŠ¨ç›‘æ§å¯ä»¥æœ‰æ•ˆé¿å…ç±»ä¼¼é—®é¢˜å†æ¬¡å‘ç”Ÿã€‚
