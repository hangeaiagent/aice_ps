# NanoBanana 502错误解决方案及预防措施

**文档版本**: v1.0  
**创建日期**: 2025-09-18  
**问题解决时间**: 2025-09-18 09:46 UTC  

## 🚨 问题概述

### 错误现象
```
GET https://nanobanana.gitagent.io/api/user-permissions/e1b114bd-fe81-4822-b1f2-de28abded7d9 502 (Bad Gateway)
GET https://nanobanana.gitagent.io/api/templates?sort=popular&limit=6 502 (Bad Gateway)
```

### 影响范围
- NanoBanana网站所有API请求失败
- 用户权限获取失败
- 模板数据加载失败
- 网站功能完全不可用

## 🔍 问题分析

### 根本原因
**Nginx配置错误** - API代理指向了错误的后端端口

### 详细分析

1. **Nginx错误日志显示**：
   ```
   connect() failed (111: Connection refused) while connecting to upstream, 
   upstream: "http://127.0.0.1:3001/api/..."
   ```

2. **实际服务端口**：
   - NanoBanana后端实际运行在端口 **3002**
   - Nginx配置却指向端口 **3001**

3. **配置文件位置**：
   `/etc/nginx/sites-available/nanobanana.gitagent.io`

4. **错误配置**：
   ```nginx
   location /api/ {
       proxy_pass http://localhost:3001/api/;  # ❌ 错误端口
       # ... 其他配置
   }
   ```

## ✅ 解决方案

### 1. 立即修复步骤

```bash
# 1. 修复nginx配置中的端口
sudo sed -i 's/localhost:3001/localhost:3002/g' /etc/nginx/sites-available/nanobanana.gitagent.io

# 2. 测试nginx配置
sudo nginx -t

# 3. 重新加载nginx
sudo systemctl reload nginx

# 4. 验证修复
curl -s -o /dev/null -w '%{http_code}' https://nanobanana.gitagent.io/api/templates
# 应该返回 200
```

### 2. 正确的Nginx配置

```nginx
server {
    server_name nanobanana.gitagent.io;
    
    # API 代理到后端服务 (端口3002) ✅ 正确端口
    location /api/ {
        proxy_pass http://localhost:3002/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
        
        # CORS 头部设置
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;
    }
    
    # 前端应用代理 (端口8889) ✅ 正确端口
    location / {
        proxy_pass http://localhost:8889;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }
    
    # SSL配置由Certbot管理
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/nanobanana.gitagent.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/nanobanana.gitagent.io/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}
```

## 🛡️ 预防措施

### 1. 自动监控脚本

创建了 `/home/ec2-user/nanobanana/service_monitor.sh` 脚本，功能包括：

- **端口检查**: 验证所有服务端口是否正常运行
- **URL测试**: 检查网站和API是否可访问
- **自动修复**: 检测到问题时自动重启服务
- **详细日志**: 记录所有监控活动和问题

### 2. 定时监控任务

设置了crontab定时任务：
```bash
# 每5分钟检查一次服务状态
*/5 * * * * /home/ec2-user/nanobanana/service_monitor.sh >> /home/ec2-user/nanobanana/monitor.log 2>&1
```

### 3. 服务端口标准化

| 服务 | 端口 | 说明 |
|------|------|------|
| NanoBanana Backend | 3002 | Node.js API服务 |
| NanoBanana Frontend | 8889 | Vite开发服务器 |
| Admin Backend | 8000 | Python FastAPI服务 |
| Admin Frontend | 9527 | 静态文件服务 |

### 4. 配置文件检查清单

在修改配置后，必须执行以下检查：

```bash
# 1. 检查nginx配置语法
sudo nginx -t

# 2. 检查端口配置是否正确
grep -n "proxy_pass.*localhost:" /etc/nginx/sites-available/nanobanana.gitagent.io

# 3. 验证服务端口
lsof -i :3002 -i :8889

# 4. 测试API访问
curl -I https://nanobanana.gitagent.io/api/templates

# 5. 检查nginx错误日志
sudo tail -f /var/log/nginx/error.log
```

## 📊 监控和诊断

### 1. 实时监控命令

```bash
# 检查所有服务状态
/home/ec2-user/nanobanana/startnanobananaandadmin.sh status

# 运行监控脚本
/home/ec2-user/nanobanana/service_monitor.sh

# 查看监控日志
tail -f /home/ec2-user/nanobanana/monitor.log
```

### 2. 问题诊断步骤

当出现502错误时：

1. **检查nginx错误日志**：
   ```bash
   sudo tail -20 /var/log/nginx/error.log
   ```

2. **检查服务端口**：
   ```bash
   lsof -i :3002 -i :8889 -i :8000 -i :9527
   ```

3. **检查nginx配置**：
   ```bash
   grep "proxy_pass" /etc/nginx/sites-available/nanobanana.gitagent.io
   ```

4. **测试后端服务**：
   ```bash
   curl http://localhost:3002/api/templates
   ```

### 3. 日志文件位置

- **Nginx错误日志**: `/var/log/nginx/error.log`
- **Nginx访问日志**: `/var/log/nginx/access.log`
- **监控脚本日志**: `/home/ec2-user/nanobanana/monitor.log`
- **NanoBanana后端日志**: `/home/ec2-user/nanobanana/nanobanana.log`
- **NanoBanana前端日志**: `/home/ec2-user/nanobanana/frontend.log`

## 🔧 故障恢复流程

### 自动恢复
监控脚本每5分钟自动检查，发现问题时会：
1. 记录问题详情
2. 尝试清理冲突端口
3. 重启相关服务
4. 验证修复结果

### 手动恢复
如果自动恢复失败：

```bash
# 1. 停止所有服务
/home/ec2-user/nanobanana/startnanobananaandadmin.sh stop

# 2. 清理端口
pkill -f "node.*server"
pkill -f "npm.*dev"

# 3. 检查nginx配置
sudo nginx -t

# 4. 重启服务
/home/ec2-user/nanobanana/startnanobananaandadmin.sh start

# 5. 验证恢复
curl -I https://nanobanana.gitagent.io/api/templates
```

## 📋 验收标准

修复完成后，以下检查项必须全部通过：

- [ ] `curl https://nanobanana.gitagent.io/api/templates` 返回200
- [ ] `curl https://nanobanana.gitagent.io/api/user-permissions/test` 返回200或404（不是502）
- [ ] 网站首页可以正常加载
- [ ] 浏览器控制台无502错误
- [ ] Nginx错误日志无"Connection refused"错误
- [ ] 监控脚本运行正常
- [ ] Crontab定时任务已设置

## 🎯 经验总结

### 问题根源
1. **配置不一致**: Nginx配置与实际服务端口不匹配
2. **缺乏监控**: 没有及时发现配置错误
3. **文档不完整**: 端口配置标准未明确记录

### 改进措施
1. **标准化配置**: 明确定义所有服务端口
2. **自动监控**: 定时检查服务状态和配置一致性
3. **配置验证**: 每次修改后必须验证
4. **文档完善**: 详细记录所有配置和流程

### 预防建议
1. **配置变更**: 任何nginx配置修改都必须测试
2. **端口管理**: 严格按照标准分配端口
3. **监控告警**: 设置更频繁的健康检查
4. **备份恢复**: 定期备份关键配置文件

---

**注意**: 此问题的核心是配置管理，通过标准化配置和自动监控可以有效避免类似问题再次发生。
