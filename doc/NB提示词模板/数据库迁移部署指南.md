# NB提示词模板库 - 数据库迁移部署指南

## 📋 迁移概述

本次更新将现有的静态JSON模板数据迁移到Supabase数据库，实现动态的模板管理系统。

### 🎯 主要变更
1. **数据存储**：从 `templates.json` 迁移到 Supabase 数据库表
2. **API接口**：新增完整的模板管理API
3. **前端服务**：使用新的 `TemplateService` 调用API
4. **数据结构**：扩展模板数据结构，支持用户交互、统计等

## 🗄️ 数据库迁移步骤

### 1. 执行数据库迁移脚本

在Supabase控制台的SQL编辑器中执行：

```bash
# 1. 登录Supabase控制台
# 2. 进入SQL编辑器
# 3. 执行迁移脚本
```

**执行文件**：`database/nb_template_migration.sql`

**如果遇到唯一约束错误**：
如果执行时遇到 `there is no unique or exclusion constraint matching the ON CONFLICT specification` 错误，请按以下步骤解决：

**方案1：简单系统用户创建（推荐）**
```sql
-- 创建系统用户（避免ON CONFLICT语法）
database/create_system_user_simple.sql
```

**方案2：手动步骤修复**
```sql
-- 逐步执行以下命令
database/manual_fix_steps.sql
```

**方案3：简化重建脚本**
```sql
-- 无RAISE语句的简化版本
database/clean_rebuild_simple.sql
```

**方案4：简单修复脚本**
```sql
-- 一次性执行简单修复
database/simple_fix_profiles.sql
```

**方案5：智能修复脚本**
```sql
-- 执行智能修复脚本
database/fix_user_profiles_constraint.sql
```

**方案6：手动命令**
```sql
-- 1. 删除现有表
DROP TABLE IF EXISTS nb_user_profiles CASCADE;

-- 2. 创建新表
CREATE TABLE nb_user_profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID UNIQUE NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    username VARCHAR(50) UNIQUE NOT NULL,
    avatar_url TEXT,
    bio TEXT,
    is_creator BOOLEAN DEFAULT false,
    creator_level INTEGER DEFAULT 1,
    total_templates INTEGER DEFAULT 0,
    total_downloads INTEGER DEFAULT 0,
    total_likes INTEGER DEFAULT 0,
    reputation_score INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. 创建系统用户
INSERT INTO nb_user_profiles (user_id, username, is_creator, creator_level)
VALUES ('e1b114bd-fe81-4822-b1f2-de28abded7d9'::UUID, 'System', true, 4);
```

**脚本功能**：
- ✅ 创建所有必要的数据库表
- ✅ 设置索引和触发器
- ✅ 迁移现有的4个模板数据
- ✅ 创建默认分类和标签
- ✅ 设置RLS（行级安全）策略

### 2. 系统用户配置（重要）

数据库迁移将使用现有用户作为系统用户：

```
用户ID：e1b114bd-fe81-4822-b1f2-de28abded7d9
用户名：System
角色：创作者（4级大师）
```

**注意**：此用户ID必须在Supabase Authentication中存在，否则会出现外键约束错误。

**验证步骤**：
1. 进入 Supabase Dashboard → Authentication → Users
2. 确认用户ID `e1b114bd-fe81-4822-b1f2-de28abded7d9` 存在
3. 如果不存在，请联系管理员添加此用户

### 3. 验证迁移结果

**使用验证脚本**：
```sql
-- 执行简化验证脚本（推荐）
database/verify_simple.sql

-- 或执行完整验证脚本
database/verify_migration.sql
```

**手动验证查询**：

```sql
-- 检查模板数据
SELECT 
  id, title, description, 
  author_id, category_id, 
  view_count, like_count,
  created_at
FROM nb_templates;

-- 检查分类数据
SELECT id, name, name_en, sort_order 
FROM nb_template_categories;

-- 检查标签数据
SELECT name, color, usage_count 
FROM nb_template_tags;

-- 检查模板标签关联
SELECT 
  t.title,
  string_agg(tag.name, ', ') as tags
FROM nb_templates t
LEFT JOIN nb_template_tag_relations tr ON t.id = tr.template_id
LEFT JOIN nb_template_tags tag ON tr.tag_id = tag.id
GROUP BY t.id, t.title;
```

**预期结果**：
- `nb_templates`: 4条记录（热门手办、旧照片修复、PVC玩具、软装设计师）
- `nb_template_categories`: 4条记录（图像处理、3D建模、室内设计、艺术创作）
- `nb_template_tags`: 8条记录（热门、专业、简单等）
- 模板标签关联正确

## 🚀 后端部署

### 1. 更新环境变量

确保服务器 `server/.env` 包含：

```bash
# Supabase配置
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# 其他现有配置...
```

### 2. 部署新代码

```bash
# 1. 提交代码到GitHub
git add .
git commit -m "feat: 迁移模板数据到Supabase数据库"
git push origin main

# 2. 在服务器上拉取更新
ssh -i /path/to/key.pem ec2-user@54.89.140.250
cd /home/ec2-user/nanobanana
git stash  # 如果有本地修改
git pull origin main
git stash pop  # 如果需要恢复本地修改

# 3. 重启服务
# 后端
pkill -f "node.*server"
cd server
nohup npm start > ../server.log 2>&1 &

# 前端
pkill -f "npm.*dev"
cd ..
nohup npx netlify dev --port 8889 --host 0.0.0.0 > frontend.log 2>&1 &
```

### 3. 验证部署

```bash
# 检查服务状态
netstat -tlnp | grep -E ':(8889|3002)'

# 测试API接口
curl -X GET "http://localhost:3002/api/templates?limit=5"
curl -X GET "http://localhost:3002/api/categories"
curl -X GET "http://localhost:3002/api/tags"

# 检查前端访问
curl -I http://localhost:8889
```

## 🔧 API接口说明

### 新增接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/templates` | GET | 获取模板列表（支持搜索、分页、排序） |
| `/api/templates/:id` | GET | 获取模板详情 |
| `/api/categories` | GET | 获取分类列表 |
| `/api/tags` | GET | 获取标签列表 |
| `/api/templates/:id/like` | POST | 点赞/取消点赞（需登录） |
| `/api/templates/:id/favorite` | POST | 收藏/取消收藏（需登录） |
| `/api/templates/:id/rating` | POST | 评分（需登录） |
| `/api/templates/:id/use` | POST | 记录使用（需登录） |
| `/api/user/favorites` | GET | 获取用户收藏（需登录） |

### 查询参数

**模板列表 (`/api/templates`)**：
- `page`: 页码（默认1）
- `limit`: 每页数量（默认20）
- `search`: 搜索关键词
- `category`: 分类ID
- `sort`: 排序方式（popular/latest/rating/downloads）
- `featured`: 是否特色模板
- `author`: 作者ID

## 📱 前端更新

### 主要变更

1. **新增服务**：`services/templateService.ts`
   - 封装所有模板相关API调用
   - 支持认证和错误处理

2. **组件更新**：
   - `TemplateLibraryPage.tsx`: 使用API获取模板列表
   - `StartScreen.tsx`: 获取热门模板
   - `TemplateDisplayPage.tsx`: 适配新数据结构
   - `App.tsx`: 扩展Template接口

3. **数据兼容**：
   - 新旧字段兼容（`title`/`name`, `cover_image_url`/`iconUrl`）
   - 支持扩展字段（作者、标签、统计等）

### 使用示例

```typescript
import { TemplateService } from '../services/templateService';

// 获取模板列表
const templates = await TemplateService.getTemplates({
  page: 1,
  limit: 20,
  search: '手办',
  sort: 'popular'
});

// 获取模板详情
const template = await TemplateService.getTemplate('template-id');

// 用户交互
await TemplateService.toggleLike('template-id');
await TemplateService.toggleFavorite('template-id');
await TemplateService.rateTemplate('template-id', 5);
```

## 🔍 测试验证

### 1. 功能测试

**模板浏览**：
- ✅ 访问 `/template-library` 页面
- ✅ 搜索功能正常
- ✅ 分页功能正常
- ✅ 模板卡片显示正确（标题、描述、标签、统计）

**模板详情**：
- ✅ 点击模板进入详情页
- ✅ 图片加载正常
- ✅ 提示词复制功能
- ✅ "使用此模板"功能

**首页模板**：
- ✅ 首页显示热门模板
- ✅ 模板按钮点击正常

### 2. 性能测试

```bash
# API响应时间测试
time curl "http://localhost:3002/api/templates"
time curl "http://localhost:3002/api/templates/template-figurine-design"

# 并发测试
ab -n 100 -c 10 http://localhost:3002/api/templates
```

### 3. 错误处理测试

```bash
# 测试不存在的模板
curl "http://localhost:3002/api/templates/non-existent-id"

# 测试无效参数
curl "http://localhost:3002/api/templates?page=abc&limit=xyz"
```

## 🚨 故障排除

### 常见问题

1. **唯一约束错误**
   ```
   错误：42P10: there is no unique or exclusion constraint matching the ON CONFLICT specification
   解决：先执行 database/fix_user_profiles_constraint.sql 修复脚本
   ```

2. **数据库连接失败**
   ```
   错误：supabaseUrl is required
   解决：检查环境变量SUPABASE_URL和SUPABASE_SERVICE_ROLE_KEY
   ```

3. **模板数据为空**
   ```
   错误：返回空数组
   解决：确认数据库迁移脚本执行成功，检查nb_templates表数据
   ```

4. **图片加载失败**
   ```
   错误：图片显示"加载失败"
   解决：检查图片URL是否可访问，确认网络连接
   ```

5. **用户交互功能异常**
   ```
   错误：点赞/收藏失败
   解决：确认用户已登录，检查RLS策略设置
   ```

### 日志查看

```bash
# 后端日志
tail -f /home/ec2-user/nanobanana/server.log

# 前端日志
tail -f /home/ec2-user/nanobanana/frontend.log

# 数据库日志（Supabase控制台）
# Dashboard → Logs → API/Database
```

## 📈 监控指标

### 关键指标

1. **API性能**
   - 响应时间 < 500ms
   - 成功率 > 99%
   - 并发处理能力

2. **数据库性能**
   - 查询执行时间
   - 连接池使用率
   - 索引命中率

3. **用户体验**
   - 页面加载时间
   - 图片加载成功率
   - 搜索响应速度

### 监控工具

- **Supabase Dashboard**: 数据库性能监控
- **服务器监控**: CPU、内存、网络使用率
- **应用日志**: 错误率、响应时间统计

## 🎉 迁移完成检查清单

- [ ] 数据库迁移脚本执行成功
- [ ] 系统用户创建完成
- [ ] 环境变量配置正确
- [ ] 后端服务启动正常
- [ ] 前端服务启动正常
- [ ] API接口测试通过
- [ ] 模板列表页面正常
- [ ] 模板详情页面正常
- [ ] 搜索功能正常
- [ ] 用户交互功能正常（如已登录）
- [ ] 图片加载正常
- [ ] 性能测试通过
- [ ] 错误处理测试通过

## 🔄 回滚方案

如果迁移出现问题，可以快速回滚：

1. **代码回滚**
   ```bash
   git checkout HEAD~1  # 回滚到上一个版本
   # 重启服务
   ```

2. **数据回滚**
   - 保留原有 `templates.json` 文件
   - 修改前端代码重新使用JSON文件
   - 删除新增的数据库表（可选）

3. **渐进式迁移**
   - 保持JSON和数据库双重数据源
   - 逐步切换用户到新系统
   - 确认稳定后完全切换

---

**迁移完成后，NB提示词模板库将具备完整的数据库支持，为后续的高级功能（用户生成模板、社区互动等）奠定基础！** 🚀
