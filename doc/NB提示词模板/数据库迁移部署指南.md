# NBæç¤ºè¯æ¨¡æ¿åº“ - æ•°æ®åº“è¿ç§»éƒ¨ç½²æŒ‡å—

## ğŸ“‹ è¿ç§»æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°å°†ç°æœ‰çš„é™æ€JSONæ¨¡æ¿æ•°æ®è¿ç§»åˆ°Supabaseæ•°æ®åº“ï¼Œå®ç°åŠ¨æ€çš„æ¨¡æ¿ç®¡ç†ç³»ç»Ÿã€‚

### ğŸ¯ ä¸»è¦å˜æ›´
1. **æ•°æ®å­˜å‚¨**ï¼šä» `templates.json` è¿ç§»åˆ° Supabase æ•°æ®åº“è¡¨
2. **APIæ¥å£**ï¼šæ–°å¢å®Œæ•´çš„æ¨¡æ¿ç®¡ç†API
3. **å‰ç«¯æœåŠ¡**ï¼šä½¿ç”¨æ–°çš„ `TemplateService` è°ƒç”¨API
4. **æ•°æ®ç»“æ„**ï¼šæ‰©å±•æ¨¡æ¿æ•°æ®ç»“æ„ï¼Œæ”¯æŒç”¨æˆ·äº¤äº’ã€ç»Ÿè®¡ç­‰

## ğŸ—„ï¸ æ•°æ®åº“è¿ç§»æ­¥éª¤

### 1. æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬

åœ¨Supabaseæ§åˆ¶å°çš„SQLç¼–è¾‘å™¨ä¸­æ‰§è¡Œï¼š

```bash
# 1. ç™»å½•Supabaseæ§åˆ¶å°
# 2. è¿›å…¥SQLç¼–è¾‘å™¨
# 3. æ‰§è¡Œè¿ç§»è„šæœ¬
```

**æ‰§è¡Œæ–‡ä»¶**ï¼š`database/nb_template_migration.sql`

**å¦‚æœé‡åˆ°å”¯ä¸€çº¦æŸé”™è¯¯**ï¼š
å¦‚æœæ‰§è¡Œæ—¶é‡åˆ° `there is no unique or exclusion constraint matching the ON CONFLICT specification` é”™è¯¯ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤è§£å†³ï¼š

**æ–¹æ¡ˆ1ï¼šç®€å•ç³»ç»Ÿç”¨æˆ·åˆ›å»ºï¼ˆæ¨èï¼‰**
```sql
-- åˆ›å»ºç³»ç»Ÿç”¨æˆ·ï¼ˆé¿å…ON CONFLICTè¯­æ³•ï¼‰
database/create_system_user_simple.sql
```

**æ–¹æ¡ˆ2ï¼šæ‰‹åŠ¨æ­¥éª¤ä¿®å¤**
```sql
-- é€æ­¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤
database/manual_fix_steps.sql
```

**æ–¹æ¡ˆ3ï¼šç®€åŒ–é‡å»ºè„šæœ¬**
```sql
-- æ— RAISEè¯­å¥çš„ç®€åŒ–ç‰ˆæœ¬
database/clean_rebuild_simple.sql
```

**æ–¹æ¡ˆ4ï¼šç®€å•ä¿®å¤è„šæœ¬**
```sql
-- ä¸€æ¬¡æ€§æ‰§è¡Œç®€å•ä¿®å¤
database/simple_fix_profiles.sql
```

**æ–¹æ¡ˆ5ï¼šæ™ºèƒ½ä¿®å¤è„šæœ¬**
```sql
-- æ‰§è¡Œæ™ºèƒ½ä¿®å¤è„šæœ¬
database/fix_user_profiles_constraint.sql
```

**æ–¹æ¡ˆ6ï¼šæ‰‹åŠ¨å‘½ä»¤**
```sql
-- 1. åˆ é™¤ç°æœ‰è¡¨
DROP TABLE IF EXISTS nb_user_profiles CASCADE;

-- 2. åˆ›å»ºæ–°è¡¨
CREATE TABLE nb_user_profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID UNIQUE NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    username VARCHAR(50) UNIQUE NOT NULL,
    avatar_url TEXT,
    bio TEXT,
    is_creator BOOLEAN DEFAULT false,
    creator_level INTEGER DEFAULT 1,
    total_templates INTEGER DEFAULT 0,
    total_downloads INTEGER DEFAULT 0,
    total_likes INTEGER DEFAULT 0,
    reputation_score INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. åˆ›å»ºç³»ç»Ÿç”¨æˆ·
INSERT INTO nb_user_profiles (user_id, username, is_creator, creator_level)
VALUES ('e1b114bd-fe81-4822-b1f2-de28abded7d9'::UUID, 'System', true, 4);
```

**è„šæœ¬åŠŸèƒ½**ï¼š
- âœ… åˆ›å»ºæ‰€æœ‰å¿…è¦çš„æ•°æ®åº“è¡¨
- âœ… è®¾ç½®ç´¢å¼•å’Œè§¦å‘å™¨
- âœ… è¿ç§»ç°æœ‰çš„4ä¸ªæ¨¡æ¿æ•°æ®
- âœ… åˆ›å»ºé»˜è®¤åˆ†ç±»å’Œæ ‡ç­¾
- âœ… è®¾ç½®RLSï¼ˆè¡Œçº§å®‰å…¨ï¼‰ç­–ç•¥

### 2. ç³»ç»Ÿç”¨æˆ·é…ç½®ï¼ˆé‡è¦ï¼‰

æ•°æ®åº“è¿ç§»å°†ä½¿ç”¨ç°æœ‰ç”¨æˆ·ä½œä¸ºç³»ç»Ÿç”¨æˆ·ï¼š

```
ç”¨æˆ·IDï¼še1b114bd-fe81-4822-b1f2-de28abded7d9
ç”¨æˆ·åï¼šSystem
è§’è‰²ï¼šåˆ›ä½œè€…ï¼ˆ4çº§å¤§å¸ˆï¼‰
```

**æ³¨æ„**ï¼šæ­¤ç”¨æˆ·IDå¿…é¡»åœ¨Supabase Authenticationä¸­å­˜åœ¨ï¼Œå¦åˆ™ä¼šå‡ºç°å¤–é”®çº¦æŸé”™è¯¯ã€‚

**éªŒè¯æ­¥éª¤**ï¼š
1. è¿›å…¥ Supabase Dashboard â†’ Authentication â†’ Users
2. ç¡®è®¤ç”¨æˆ·ID `e1b114bd-fe81-4822-b1f2-de28abded7d9` å­˜åœ¨
3. å¦‚æœä¸å­˜åœ¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ·»åŠ æ­¤ç”¨æˆ·

### 3. éªŒè¯è¿ç§»ç»“æœ

**ä½¿ç”¨éªŒè¯è„šæœ¬**ï¼š
```sql
-- æ‰§è¡Œç®€åŒ–éªŒè¯è„šæœ¬ï¼ˆæ¨èï¼‰
database/verify_simple.sql

-- æˆ–æ‰§è¡Œå®Œæ•´éªŒè¯è„šæœ¬
database/verify_migration.sql
```

**æ‰‹åŠ¨éªŒè¯æŸ¥è¯¢**ï¼š

```sql
-- æ£€æŸ¥æ¨¡æ¿æ•°æ®
SELECT 
  id, title, description, 
  author_id, category_id, 
  view_count, like_count,
  created_at
FROM nb_templates;

-- æ£€æŸ¥åˆ†ç±»æ•°æ®
SELECT id, name, name_en, sort_order 
FROM nb_template_categories;

-- æ£€æŸ¥æ ‡ç­¾æ•°æ®
SELECT name, color, usage_count 
FROM nb_template_tags;

-- æ£€æŸ¥æ¨¡æ¿æ ‡ç­¾å…³è”
SELECT 
  t.title,
  string_agg(tag.name, ', ') as tags
FROM nb_templates t
LEFT JOIN nb_template_tag_relations tr ON t.id = tr.template_id
LEFT JOIN nb_template_tags tag ON tr.tag_id = tag.id
GROUP BY t.id, t.title;
```

**é¢„æœŸç»“æœ**ï¼š
- `nb_templates`: 4æ¡è®°å½•ï¼ˆçƒ­é—¨æ‰‹åŠã€æ—§ç…§ç‰‡ä¿®å¤ã€PVCç©å…·ã€è½¯è£…è®¾è®¡å¸ˆï¼‰
- `nb_template_categories`: 4æ¡è®°å½•ï¼ˆå›¾åƒå¤„ç†ã€3Då»ºæ¨¡ã€å®¤å†…è®¾è®¡ã€è‰ºæœ¯åˆ›ä½œï¼‰
- `nb_template_tags`: 8æ¡è®°å½•ï¼ˆçƒ­é—¨ã€ä¸“ä¸šã€ç®€å•ç­‰ï¼‰
- æ¨¡æ¿æ ‡ç­¾å…³è”æ­£ç¡®

## ğŸš€ åç«¯éƒ¨ç½²

### 1. æ›´æ–°ç¯å¢ƒå˜é‡

ç¡®ä¿æœåŠ¡å™¨ `server/.env` åŒ…å«ï¼š

```bash
# Supabaseé…ç½®
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# å…¶ä»–ç°æœ‰é…ç½®...
```

### 2. éƒ¨ç½²æ–°ä»£ç 

```bash
# 1. æäº¤ä»£ç åˆ°GitHub
git add .
git commit -m "feat: è¿ç§»æ¨¡æ¿æ•°æ®åˆ°Supabaseæ•°æ®åº“"
git push origin main

# 2. åœ¨æœåŠ¡å™¨ä¸Šæ‹‰å–æ›´æ–°
ssh -i /path/to/key.pem ec2-user@54.89.140.250
cd /home/ec2-user/nanobanana
git stash  # å¦‚æœæœ‰æœ¬åœ°ä¿®æ”¹
git pull origin main
git stash pop  # å¦‚æœéœ€è¦æ¢å¤æœ¬åœ°ä¿®æ”¹

# 3. é‡å¯æœåŠ¡
# åç«¯
pkill -f "node.*server"
cd server
nohup npm start > ../server.log 2>&1 &

# å‰ç«¯
pkill -f "npm.*dev"
cd ..
nohup npx netlify dev --port 8889 --host 0.0.0.0 > frontend.log 2>&1 &
```

### 3. éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
netstat -tlnp | grep -E ':(8889|3002)'

# æµ‹è¯•APIæ¥å£
curl -X GET "http://localhost:3002/api/templates?limit=5"
curl -X GET "http://localhost:3002/api/categories"
curl -X GET "http://localhost:3002/api/tags"

# æ£€æŸ¥å‰ç«¯è®¿é—®
curl -I http://localhost:8889
```

## ğŸ”§ APIæ¥å£è¯´æ˜

### æ–°å¢æ¥å£

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/templates` | GET | è·å–æ¨¡æ¿åˆ—è¡¨ï¼ˆæ”¯æŒæœç´¢ã€åˆ†é¡µã€æ’åºï¼‰ |
| `/api/templates/:id` | GET | è·å–æ¨¡æ¿è¯¦æƒ… |
| `/api/categories` | GET | è·å–åˆ†ç±»åˆ—è¡¨ |
| `/api/tags` | GET | è·å–æ ‡ç­¾åˆ—è¡¨ |
| `/api/templates/:id/like` | POST | ç‚¹èµ/å–æ¶ˆç‚¹èµï¼ˆéœ€ç™»å½•ï¼‰ |
| `/api/templates/:id/favorite` | POST | æ”¶è—/å–æ¶ˆæ”¶è—ï¼ˆéœ€ç™»å½•ï¼‰ |
| `/api/templates/:id/rating` | POST | è¯„åˆ†ï¼ˆéœ€ç™»å½•ï¼‰ |
| `/api/templates/:id/use` | POST | è®°å½•ä½¿ç”¨ï¼ˆéœ€ç™»å½•ï¼‰ |
| `/api/user/favorites` | GET | è·å–ç”¨æˆ·æ”¶è—ï¼ˆéœ€ç™»å½•ï¼‰ |

### æŸ¥è¯¢å‚æ•°

**æ¨¡æ¿åˆ—è¡¨ (`/api/templates`)**ï¼š
- `page`: é¡µç ï¼ˆé»˜è®¤1ï¼‰
- `limit`: æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤20ï¼‰
- `search`: æœç´¢å…³é”®è¯
- `category`: åˆ†ç±»ID
- `sort`: æ’åºæ–¹å¼ï¼ˆpopular/latest/rating/downloadsï¼‰
- `featured`: æ˜¯å¦ç‰¹è‰²æ¨¡æ¿
- `author`: ä½œè€…ID

## ğŸ“± å‰ç«¯æ›´æ–°

### ä¸»è¦å˜æ›´

1. **æ–°å¢æœåŠ¡**ï¼š`services/templateService.ts`
   - å°è£…æ‰€æœ‰æ¨¡æ¿ç›¸å…³APIè°ƒç”¨
   - æ”¯æŒè®¤è¯å’Œé”™è¯¯å¤„ç†

2. **ç»„ä»¶æ›´æ–°**ï¼š
   - `TemplateLibraryPage.tsx`: ä½¿ç”¨APIè·å–æ¨¡æ¿åˆ—è¡¨
   - `StartScreen.tsx`: è·å–çƒ­é—¨æ¨¡æ¿
   - `TemplateDisplayPage.tsx`: é€‚é…æ–°æ•°æ®ç»“æ„
   - `App.tsx`: æ‰©å±•Templateæ¥å£

3. **æ•°æ®å…¼å®¹**ï¼š
   - æ–°æ—§å­—æ®µå…¼å®¹ï¼ˆ`title`/`name`, `cover_image_url`/`iconUrl`ï¼‰
   - æ”¯æŒæ‰©å±•å­—æ®µï¼ˆä½œè€…ã€æ ‡ç­¾ã€ç»Ÿè®¡ç­‰ï¼‰

### ä½¿ç”¨ç¤ºä¾‹

```typescript
import { TemplateService } from '../services/templateService';

// è·å–æ¨¡æ¿åˆ—è¡¨
const templates = await TemplateService.getTemplates({
  page: 1,
  limit: 20,
  search: 'æ‰‹åŠ',
  sort: 'popular'
});

// è·å–æ¨¡æ¿è¯¦æƒ…
const template = await TemplateService.getTemplate('template-id');

// ç”¨æˆ·äº¤äº’
await TemplateService.toggleLike('template-id');
await TemplateService.toggleFavorite('template-id');
await TemplateService.rateTemplate('template-id', 5);
```

## ğŸ” æµ‹è¯•éªŒè¯

### 1. åŠŸèƒ½æµ‹è¯•

**æ¨¡æ¿æµè§ˆ**ï¼š
- âœ… è®¿é—® `/template-library` é¡µé¢
- âœ… æœç´¢åŠŸèƒ½æ­£å¸¸
- âœ… åˆ†é¡µåŠŸèƒ½æ­£å¸¸
- âœ… æ¨¡æ¿å¡ç‰‡æ˜¾ç¤ºæ­£ç¡®ï¼ˆæ ‡é¢˜ã€æè¿°ã€æ ‡ç­¾ã€ç»Ÿè®¡ï¼‰

**æ¨¡æ¿è¯¦æƒ…**ï¼š
- âœ… ç‚¹å‡»æ¨¡æ¿è¿›å…¥è¯¦æƒ…é¡µ
- âœ… å›¾ç‰‡åŠ è½½æ­£å¸¸
- âœ… æç¤ºè¯å¤åˆ¶åŠŸèƒ½
- âœ… "ä½¿ç”¨æ­¤æ¨¡æ¿"åŠŸèƒ½

**é¦–é¡µæ¨¡æ¿**ï¼š
- âœ… é¦–é¡µæ˜¾ç¤ºçƒ­é—¨æ¨¡æ¿
- âœ… æ¨¡æ¿æŒ‰é’®ç‚¹å‡»æ­£å¸¸

### 2. æ€§èƒ½æµ‹è¯•

```bash
# APIå“åº”æ—¶é—´æµ‹è¯•
time curl "http://localhost:3002/api/templates"
time curl "http://localhost:3002/api/templates/template-figurine-design"

# å¹¶å‘æµ‹è¯•
ab -n 100 -c 10 http://localhost:3002/api/templates
```

### 3. é”™è¯¯å¤„ç†æµ‹è¯•

```bash
# æµ‹è¯•ä¸å­˜åœ¨çš„æ¨¡æ¿
curl "http://localhost:3002/api/templates/non-existent-id"

# æµ‹è¯•æ— æ•ˆå‚æ•°
curl "http://localhost:3002/api/templates?page=abc&limit=xyz"
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å”¯ä¸€çº¦æŸé”™è¯¯**
   ```
   é”™è¯¯ï¼š42P10: there is no unique or exclusion constraint matching the ON CONFLICT specification
   è§£å†³ï¼šå…ˆæ‰§è¡Œ database/fix_user_profiles_constraint.sql ä¿®å¤è„šæœ¬
   ```

2. **æ•°æ®åº“è¿æ¥å¤±è´¥**
   ```
   é”™è¯¯ï¼šsupabaseUrl is required
   è§£å†³ï¼šæ£€æŸ¥ç¯å¢ƒå˜é‡SUPABASE_URLå’ŒSUPABASE_SERVICE_ROLE_KEY
   ```

3. **æ¨¡æ¿æ•°æ®ä¸ºç©º**
   ```
   é”™è¯¯ï¼šè¿”å›ç©ºæ•°ç»„
   è§£å†³ï¼šç¡®è®¤æ•°æ®åº“è¿ç§»è„šæœ¬æ‰§è¡ŒæˆåŠŸï¼Œæ£€æŸ¥nb_templatesè¡¨æ•°æ®
   ```

4. **å›¾ç‰‡åŠ è½½å¤±è´¥**
   ```
   é”™è¯¯ï¼šå›¾ç‰‡æ˜¾ç¤º"åŠ è½½å¤±è´¥"
   è§£å†³ï¼šæ£€æŸ¥å›¾ç‰‡URLæ˜¯å¦å¯è®¿é—®ï¼Œç¡®è®¤ç½‘ç»œè¿æ¥
   ```

5. **ç”¨æˆ·äº¤äº’åŠŸèƒ½å¼‚å¸¸**
   ```
   é”™è¯¯ï¼šç‚¹èµ/æ”¶è—å¤±è´¥
   è§£å†³ï¼šç¡®è®¤ç”¨æˆ·å·²ç™»å½•ï¼Œæ£€æŸ¥RLSç­–ç•¥è®¾ç½®
   ```

### æ—¥å¿—æŸ¥çœ‹

```bash
# åç«¯æ—¥å¿—
tail -f /home/ec2-user/nanobanana/server.log

# å‰ç«¯æ—¥å¿—
tail -f /home/ec2-user/nanobanana/frontend.log

# æ•°æ®åº“æ—¥å¿—ï¼ˆSupabaseæ§åˆ¶å°ï¼‰
# Dashboard â†’ Logs â†’ API/Database
```

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡

1. **APIæ€§èƒ½**
   - å“åº”æ—¶é—´ < 500ms
   - æˆåŠŸç‡ > 99%
   - å¹¶å‘å¤„ç†èƒ½åŠ›

2. **æ•°æ®åº“æ€§èƒ½**
   - æŸ¥è¯¢æ‰§è¡Œæ—¶é—´
   - è¿æ¥æ± ä½¿ç”¨ç‡
   - ç´¢å¼•å‘½ä¸­ç‡

3. **ç”¨æˆ·ä½“éªŒ**
   - é¡µé¢åŠ è½½æ—¶é—´
   - å›¾ç‰‡åŠ è½½æˆåŠŸç‡
   - æœç´¢å“åº”é€Ÿåº¦

### ç›‘æ§å·¥å…·

- **Supabase Dashboard**: æ•°æ®åº“æ€§èƒ½ç›‘æ§
- **æœåŠ¡å™¨ç›‘æ§**: CPUã€å†…å­˜ã€ç½‘ç»œä½¿ç”¨ç‡
- **åº”ç”¨æ—¥å¿—**: é”™è¯¯ç‡ã€å“åº”æ—¶é—´ç»Ÿè®¡

## ğŸ‰ è¿ç§»å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] æ•°æ®åº“è¿ç§»è„šæœ¬æ‰§è¡ŒæˆåŠŸ
- [ ] ç³»ç»Ÿç”¨æˆ·åˆ›å»ºå®Œæˆ
- [ ] ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
- [ ] åç«¯æœåŠ¡å¯åŠ¨æ­£å¸¸
- [ ] å‰ç«¯æœåŠ¡å¯åŠ¨æ­£å¸¸
- [ ] APIæ¥å£æµ‹è¯•é€šè¿‡
- [ ] æ¨¡æ¿åˆ—è¡¨é¡µé¢æ­£å¸¸
- [ ] æ¨¡æ¿è¯¦æƒ…é¡µé¢æ­£å¸¸
- [ ] æœç´¢åŠŸèƒ½æ­£å¸¸
- [ ] ç”¨æˆ·äº¤äº’åŠŸèƒ½æ­£å¸¸ï¼ˆå¦‚å·²ç™»å½•ï¼‰
- [ ] å›¾ç‰‡åŠ è½½æ­£å¸¸
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡
- [ ] é”™è¯¯å¤„ç†æµ‹è¯•é€šè¿‡

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœè¿ç§»å‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

1. **ä»£ç å›æ»š**
   ```bash
   git checkout HEAD~1  # å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
   # é‡å¯æœåŠ¡
   ```

2. **æ•°æ®å›æ»š**
   - ä¿ç•™åŸæœ‰ `templates.json` æ–‡ä»¶
   - ä¿®æ”¹å‰ç«¯ä»£ç é‡æ–°ä½¿ç”¨JSONæ–‡ä»¶
   - åˆ é™¤æ–°å¢çš„æ•°æ®åº“è¡¨ï¼ˆå¯é€‰ï¼‰

3. **æ¸è¿›å¼è¿ç§»**
   - ä¿æŒJSONå’Œæ•°æ®åº“åŒé‡æ•°æ®æº
   - é€æ­¥åˆ‡æ¢ç”¨æˆ·åˆ°æ–°ç³»ç»Ÿ
   - ç¡®è®¤ç¨³å®šåå®Œå…¨åˆ‡æ¢

---

**è¿ç§»å®Œæˆåï¼ŒNBæç¤ºè¯æ¨¡æ¿åº“å°†å…·å¤‡å®Œæ•´çš„æ•°æ®åº“æ”¯æŒï¼Œä¸ºåç»­çš„é«˜çº§åŠŸèƒ½ï¼ˆç”¨æˆ·ç”Ÿæˆæ¨¡æ¿ã€ç¤¾åŒºäº’åŠ¨ç­‰ï¼‰å¥ å®šåŸºç¡€ï¼** ğŸš€
