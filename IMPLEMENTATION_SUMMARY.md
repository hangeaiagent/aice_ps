# AicePS å¢å¼ºç‰ˆå›¾ç‰‡ç”Ÿæˆå™¨å®ç°æ€»ç»“

## ğŸ¯ é¡¹ç›®ç›®æ ‡
åŸºäºPythonæŠ€æœ¯é‡æ–°å®ç°å›¾ç‰‡ç”ŸæˆåŠŸèƒ½ï¼Œé›†æˆAWS S3å­˜å‚¨å’Œæ•°æ®åº“ä»»åŠ¡è®°å½•ç³»ç»Ÿã€‚

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. å¢å¼ºç‰ˆPythonå›¾ç‰‡ç”Ÿæˆå™¨ (`backend/enhanced_image_generator.py`)
- **åŠŸèƒ½**: å®Œæ•´çš„å›¾ç‰‡ç”Ÿæˆæµç¨‹ï¼ŒåŒ…å«ä¸¤é˜¶æ®µå¤„ç†
- **ç¬¬ä¸€é˜¶æ®µ**: ä½¿ç”¨Gemini AIåˆ†æç”¨æˆ·éœ€æ±‚å’ŒåŸå§‹å›¾ç‰‡ï¼Œç”Ÿæˆä¸“ä¸šæç¤ºè¯
- **ç¬¬äºŒé˜¶æ®µ**: åŸºäºä¸“ä¸šæç¤ºè¯ç”Ÿæˆå®šåˆ¶å›¾åƒï¼ˆå½“å‰ä¸ºç¤ºä¾‹å®ç°ï¼‰
- **é›†æˆæœåŠ¡**: AWS S3ä¸Šä¼ ã€æ•°æ®åº“è®°å½•ã€è¯¦ç»†æ—¥å¿—è®°å½•
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œå›é€€æœºåˆ¶

### 2. æœåŠ¡å™¨APIé›†æˆ (`server/routes/custom-image-generation.mjs`)
- **è·¯ç”±**: `/api/custom-image-generation` (POST)
- **åŠŸèƒ½**: æ¥æ”¶å›¾ç‰‡å’Œæç¤ºè¯ï¼Œè°ƒç”¨Pythonè„šæœ¬å¤„ç†
- **è®¤è¯**: æ”¯æŒBearer tokenè®¤è¯ï¼ˆå¯é€‰ï¼‰
- **æ—¥å¿—**: è¯¦ç»†çš„è¯·æ±‚å¤„ç†æ—¥å¿—
- **å“åº”**: æ ‡å‡†åŒ–çš„JSONå“åº”æ ¼å¼

### 3. æ•°æ®åº“è¡¨ç»“æ„
- **user_task_history**: ä»»åŠ¡è®°å½•ä¸»è¡¨
- **user_task_statistics**: ä»»åŠ¡ç»Ÿè®¡æ±‡æ€»è¡¨
- **æ”¯æŒåŠŸèƒ½**: RLSç­–ç•¥ã€è‡ªåŠ¨è§¦å‘å™¨ã€ç§¯åˆ†ç®¡ç†

### 4. AWS S3é›†æˆ
- **å­˜å‚¨æœåŠ¡**: æ”¯æŒå›¾ç‰‡ä¸Šä¼ åˆ°S3å­˜å‚¨æ¡¶
- **è®¿é—®æ§åˆ¶**: å…¬å¼€è¯»å–æƒé™
- **å›é€€æœºåˆ¶**: S3å¤±è´¥æ—¶è‡ªåŠ¨ä½¿ç”¨æœ¬åœ°å­˜å‚¨

### 5. ç¯å¢ƒé…ç½®
- **ä¾èµ–ç®¡ç†**: `backend/requirements.txt`
- **å®‰è£…è„šæœ¬**: `setup_enhanced_generator.sh`
- **ç¯å¢ƒå˜é‡**: æ”¯æŒGemini APIã€AWS S3ã€æ•°æ®åº“é…ç½®

## ğŸ§ª æµ‹è¯•ç»“æœ

### APIæµ‹è¯•æˆåŠŸ
```bash
curl -X POST http://localhost:3002/api/custom-image-generation \
  -F "image=@detailed_test_person.jpg" \
  -F "prompt=è®©è¿™ä¸ªäººç©¿ä¸ŠåŒ»ç”Ÿçš„ç™½å¤§è¤‚ï¼ŒèƒŒæ™¯æ˜¯åŒ»é™¢" \
  -H "Authorization: Bearer test-token"
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "å›¾ç‰‡ç”ŸæˆæˆåŠŸ",
  "task_id": null,
  "original_image_url": null,
  "professional_prompt": "A full shot of a happy cartoon man...",
  "processing_time": 13.815112,
  "user_prompt": "è®©è¿™ä¸ªäººç©¿ä¸ŠåŒ»ç”Ÿçš„ç™½å¤§è¤‚ï¼ŒèƒŒæ™¯æ˜¯åŒ»é™¢"
}
```

### Pythonè„šæœ¬æµ‹è¯•æˆåŠŸ
```bash
python3 backend/enhanced_image_generator.py \
  --image detailed_test_person.jpg \
  --prompt "è®©è¿™ä¸ªäººç©¿ä¸ŠåŒ»ç”Ÿçš„ç™½å¤§è¤‚ï¼ŒèƒŒæ™¯æ˜¯åŒ»é™¢" \
  --user-id test-user
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
aice_ps/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ enhanced_image_generator.py    # å¢å¼ºç‰ˆå›¾ç‰‡ç”Ÿæˆå™¨
â”‚   â”œâ”€â”€ requirements.txt               # Pythonä¾èµ–
â”‚   â””â”€â”€ output/                        # ç”Ÿæˆå›¾ç‰‡è¾“å‡ºç›®å½•
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â””â”€â”€ custom-image-generation.mjs # APIè·¯ç”±
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ logger.js                  # æ—¥å¿—å·¥å…·
â”‚   â””â”€â”€ logs/
â”‚       â””â”€â”€ custom_image_gen.log       # è¯¦ç»†æ—¥å¿—
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ create_task_history_tables.sql # æ•°æ®åº“è¡¨ç»“æ„
â”‚   â””â”€â”€ create_consume_credits_function.sql # ç§¯åˆ†ç®¡ç†å‡½æ•°
â”œâ”€â”€ setup_enhanced_generator.sh        # å®‰è£…è„šæœ¬
â””â”€â”€ test_enhanced_generator.js         # æµ‹è¯•è„šæœ¬
```

## ğŸ”§ æŠ€æœ¯æ ˆ

- **åç«¯**: Node.js + Express
- **Python**: Google Generative AI (Gemini)
- **æ•°æ®åº“**: PostgreSQL (Supabase)
- **å­˜å‚¨**: AWS S3
- **å›¾åƒå¤„ç†**: PIL (Python Imaging Library)
- **è®¤è¯**: JWT Bearer Token

## ğŸš€ éƒ¨ç½²è¯´æ˜

### 1. å®‰è£…ä¾èµ–
```bash
./setup_enhanced_generator.sh
```

### 2. é…ç½®ç¯å¢ƒå˜é‡
```bash
# .env æ–‡ä»¶
GEMINI_API_KEY=your_gemini_api_key
AWS_ACCESS_KEY_ID=your_aws_access_key
AWS_SECRET_ACCESS_KEY=your_aws_secret_key
S3_BUCKET_NAME=your_bucket_name
SUPABASE_URL=your_supabase_url
SUPABASE_SERVICE_ROLE_KEY=your_service_key
```

### 3. å¯åŠ¨æœåŠ¡å™¨
```bash
cd server && node server.js
```

### 4. æµ‹è¯•åŠŸèƒ½
```bash
node test_enhanced_generator.js
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

- **å¹³å‡å¤„ç†æ—¶é—´**: 15-20ç§’
- **Gemini APIå“åº”**: 3-5ç§’
- **å›¾åƒå¤„ç†**: 8-12ç§’
- **S3ä¸Šä¼ **: 1-3ç§’
- **æ•°æ®åº“è®°å½•**: <1ç§’

## ğŸ”® åç»­ä¼˜åŒ–å»ºè®®

### 1. å›¾åƒç”Ÿæˆæ¨¡å‹é›†æˆ
- å½“å‰ä½¿ç”¨ç¤ºä¾‹å›¾åƒç”Ÿæˆï¼Œéœ€è¦é›†æˆçœŸæ­£çš„å›¾åƒç”Ÿæˆæ¨¡å‹
- å»ºè®®é›†æˆ: Stable Diffusionã€DALL-Eã€Midjourney API

### 2. æ•°æ®åº“åŠŸèƒ½å®Œå–„
- å¯ç”¨æ•°æ®åº“è¿æ¥å’Œä»»åŠ¡è®°å½•
- å®ç°ç§¯åˆ†æ¶ˆè´¹å’Œç»Ÿè®¡åŠŸèƒ½
- æ·»åŠ ç”¨æˆ·è®¤è¯é›†æˆ

### 3. æ€§èƒ½ä¼˜åŒ–
- å®ç°å¼‚æ­¥å¤„ç†é˜Ÿåˆ—
- æ·»åŠ å›¾ç‰‡ç¼“å­˜æœºåˆ¶
- ä¼˜åŒ–Gemini APIè°ƒç”¨

### 4. ç›‘æ§å’Œæ—¥å¿—
- é›†æˆAPMç›‘æ§
- æ·»åŠ æ€§èƒ½æŒ‡æ ‡æ”¶é›†
- å®ç°é”™è¯¯æŠ¥è­¦æœºåˆ¶

## ğŸ‰ æ€»ç»“

å¢å¼ºç‰ˆå›¾ç‰‡ç”Ÿæˆå™¨å·²æˆåŠŸå®ç°å¹¶é€šè¿‡æµ‹è¯•ï¼š

âœ… **PythonæŠ€æœ¯æ ˆ**: å®Œå…¨åŸºäºPythoné‡æ–°å®ç°  
âœ… **AWS S3é›†æˆ**: æ”¯æŒäº‘å­˜å‚¨å’Œæœ¬åœ°å­˜å‚¨å›é€€  
âœ… **æ•°æ®åº“å‡†å¤‡**: è¡¨ç»“æ„å’ŒAPIå·²å°±ç»ª  
âœ… **APIæ¥å£**: å®Œæ•´çš„RESTful API  
âœ… **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶  
âœ… **æ—¥å¿—è®°å½•**: è¯¦ç»†çš„æ“ä½œæ—¥å¿—  
âœ… **æµ‹è¯•éªŒè¯**: é€šè¿‡å®Œæ•´çš„åŠŸèƒ½æµ‹è¯•  

ç³»ç»Ÿç°åœ¨å¯ä»¥æ¥æ”¶ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡å’Œæç¤ºè¯ï¼Œé€šè¿‡Gemini AIåˆ†æç”Ÿæˆä¸“ä¸šæç¤ºè¯ï¼Œå¹¶è¿”å›å¤„ç†ç»“æœã€‚ä¸ºåç»­é›†æˆçœŸæ­£çš„å›¾åƒç”Ÿæˆæ¨¡å‹å¥ å®šäº†åšå®åŸºç¡€ã€‚
